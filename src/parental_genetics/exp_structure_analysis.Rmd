---
title: "exp_structure_analysis"
authors: "Nicole Mongillo and Madeline Eppley"
date: "2025-05-23"
output: pdf_document
---

This file creates an sNMF admixture plots and ancestry pie charts. The analysis is from MGE's 
code in "updated_genetics_experimental.R." NM modified the code for plotting for this project.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory relative to project root
knitr::opts_knit$set(root.dir = here::here())

if (!require("pacman")) install.packages("pacman")

packages <- c("here", "ggplot2", "LEA", "scatterpie", "sf", "rnaturalearth", "rnaturalearthdata", "dplyr", "stringr")
pacman::p_load(char = packages)

# log versions for reproducibility
r_version <- paste(R.version$major, R.version$minor, sep = ".")
lib_ver <- packages %>%
  map_chr(~ paste0(.x, " (v", packageVersion(.x), ")")) %>%
  paste(collapse = ", ")
```

```{r}
getwd()
```

## Set region colors
```{r}

# can update region colors to whatever we want to see here
region_colors <- c(
  "W1-TX" = "#3e4989",
  "W2-LA" = "#31688e", 
  "W3-FL" = "#26828e",
  "W4-VA" = "#1f9e89",
  "S1-LOLA" = "#440154", 
  "S2-DEBY" = "#482878",
  "W5-NH" = "#35b779",
  "W6-ME" = "#6ece58"
  )
```

```{r}
pca_data <- read.csv("results/parental_genetics/20250604_pca_data_exp.csv")

#rename values in ID_SiteDate to match naming scheme
pca_data <- pca_data %>%
  mutate(ID_SiteDate = case_match(ID_SiteDate,
                                   "TX-CapBay" ~ "W1-TX",
                                   "LA-SisLake" ~ "W2-LA",
                                   "FL-KingPlan" ~ "W3-FL",
                                   "VA-DeepWatSh" ~ "W4-VA",
                                   "LOLA" ~ "S1-LOLA",
                                   "DEBY" ~ "S2-DEBY",
                                   "NH-GrtBay" ~ "W5-NH",
                                   "ME-HogIs" ~ "W6-ME"
                                   ))

# plot PCA by plate to check for batch effects - just see pl6 and pl7 here
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = Plate)) +
  geom_point(size = 1) + 
  labs(title = "PCA - Plate Extractions, exp Dataset", x = "PC1", y = "PC2", color = "Plate") +
  theme_minimal()

pca_plot

# PCs 3 and 4 checking for batch effects
pca_plot2 <- ggplot(pca_data, aes(x = PC3, y = PC4, color = Plate)) +
  geom_point(size = 1) + 
  labs(title = "PCA - Plate Extractions, Whole Dataset", x = "PC3", y = "PC4", color = "Plate") +
  theme_minimal()

pca_plot2

# PCA plot PCs 1 and 2
centroids <- pca_data %>%
  group_by(ID_SiteDate) %>%
  summarize(PC1 = mean(PC1), PC2 = mean(PC2))

pca_plot3 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = ID_SiteDate)) +
  geom_point(size = 1) +
  stat_ellipse(aes(group = ID_SiteDate), level = 0.95) +
  #geom_text_repel(data = centroids, aes(x = PC1, y = PC2, label = ID_SiteDate), 
  # size = 3, fontface = "bold", box.padding = 0.5, point.padding = 0.5) +
  labs(title = "Parental Groups Genetic PCA", x = "PC1", y = "PC2") +
  scale_color_manual(values = region_colors) +
  theme_minimal()+
  theme(legend.position = "none")

pca_plot3

# ggsave("parental_pca.pdf",
#        plot = pca_plot3,
#        device = "pdf",
#        path = "figures/envr_of_origin",
#        height = 4,
#        width = 5)
```

```{r}
# now PCs 3 and 4
centroids34 <- pca_data %>%
  group_by(ID_SiteDate) %>%
  summarize(PC3 = mean(PC3), PC4 = mean(PC4))

pca_plot4 <- ggplot(pca_data, aes(x = PC3, y = PC4, color = ID_SiteDate)) +
  geom_point(size = 1) +
  stat_ellipse(aes(group = ID_SiteDate), level = 0.95) +
  #geom_text_repel(data = centroids34, aes(x = PC3, y = PC4, label = ID_SiteDate), 
                  #size = 3, fontface = "bold", box.padding = 0.5, point.padding = 0.5) +
  labs(title = "PCA Plot exp Samples", x = "PC3", y = "PC4", color = "Region") +
  theme_minimal()

pca_plot4
```

## snmf ancestry analysis

```{r}
# subset the last geno matrix that we made (GEN_filtered) with our thinned SNPs list from the auto_SVD function

# load imputed genotype matrix and thinned SNP indices
GEN_imputed <- readRDS("data/parental_genetics_structure/20250604_FULLSNPs_exp.rds")
thinned_snps <- readRDS("data/parental_genetics_structure/20250604_THINNEDSNPs_exp.rds")

# subset to LD-thinned SNPs
gen_filtered_subset <- GEN_imputed[, thinned_snps]

# save as .geno format for snmf analysis
write.geno(gen_filtered_subset, "data/parental_genetics_structure/20250204geno_imputedfile_exp.geno")
```

```{r}
# now generate the snmf project for our plate
snmf_exp <- snmf("data/parental_genetics_structure/20250204geno_imputedfile_exp.geno", K = 2, repetitions = 10, ploidy = 2, entropy = TRUE, project = "new")

# plot cross-entropy criterion of all runs of the project
plot(snmf_exp, cex = 1.2, col = "#1565C0", pch = 19)

# get the cross-entropy of the 10 runs for k=2
ce = cross.entropy(snmf_exp, K = 2)

# select the run with the lowest cross-entropy for k=2
best = which.min(ce)


#read in RDS file
samp_full_subset <- readRDS("data/parental_genetics_structure/20250604_samp_full_subset_exp.rds")
samp_full_subset <- samp_full_subset %>%
  mutate(ID_SiteDate = case_match(ID_SiteDate,
                                   "TX-CapBay" ~ "W1-TX",
                                   "LA-SisLake" ~ "W2-LA",
                                   "FL-KingPlan" ~ "W3-FL",
                                   "VA-DeepWatSh" ~ "W4-VA",
                                   "LOLA" ~ "S1-LOLA",
                                   "DEBY" ~ "S2-DEBY",
                                   "NH-GrtBay" ~ "W5-NH",
                                   "ME-HogIs" ~ "W6-ME"
                                   ))

# extract Q-matrix from best run
Q_mat <- Q(snmf_exp, K = 2, run = best)

# build data frame with population labels
q_df <- data.frame(
  ind = 1:nrow(Q_mat),
  Q1 = Q_mat[, 1],
  Q2 = Q_mat[, 2],
  pop = samp_full_subset$ID_SiteDate
)

# define population order (top to bottom in horizontal plot = this factor order)
pop_order <- c("W1-TX", "W2-LA", "W3-FL", "S1-LOLA", "S2-DEBY", "W4-VA", "W5-NH", "W6-ME")
q_df$pop <- factor(q_df$pop, levels = pop_order)

# order by population only, keep original individual order within each pop
q_df <- q_df %>%
  arrange(pop) %>%
  mutate(rank = row_number())

# pivot to long format for ggplot
q_long <- q_df %>%
  tidyr::pivot_longer(cols = c(Q1, Q2), names_to = "cluster", values_to = "proportion")

# calculate population boundaries for dividing lines
pop_counts <- q_df %>% group_by(pop) %>% summarise(n = n())
pop_counts$cumsum <- cumsum(pop_counts$n)
pop_breaks <- head(pop_counts$cumsum, -1) + 0.5

# calculate midpoints for population labels
pop_counts$mid <- pop_counts$cumsum - pop_counts$n / 2

# plot
snmf_plot <- ggplot(q_long, aes(x = rank, y = proportion, fill = cluster)) +
  geom_bar(stat = "identity", width = 1, linewidth = 0, color = NA) +
  geom_vline(xintercept = pop_breaks, color = "black", linewidth = 0.5) +
  scale_fill_manual(values = c("Q2" = "#81C784", "Q1" = "#1565C0")) +
  scale_x_continuous(
    breaks = pop_counts$mid,
    labels = pop_counts$pop,
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_flip() +
  labs(x = NULL, y = "Individual ancestry proportions") +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    axis.text.y = element_text(color = "black", size = 11, face = "bold"),
    axis.text.x = element_text(color = "black", size = 10),
    axis.title.x = element_text(size = 12),
    axis.ticks = element_line(color = "black"),
    axis.ticks.length = unit(0.15, "cm")
  )

snmf_plot

ggsave("FigS1_snmf_ancestry.pdf",
       plot = snmf_plot,
       device = "pdf",
       path = "figures/envr_of_origin",
       height = 6,
       width = 4)
```

## Create snmf plot results on map 
```{r}
# read in site data
site_data <- read.csv("data/performance_H2F/MVP23-FieldBags-spawn_trt2.csv")

site_data <- site_data %>%
  mutate(SpawnTrt_Label = case_match(SpawnTrt_Label,
                                   "TX-CapBay" ~ "W1-TX",
                                   "LA-SisLake" ~ "W2-LA",
                                   "FL-KingPlan" ~ "W3-FL",
                                   "VA-DeepWatSh" ~ "W4-VA",
                                   "LOLA" ~ "S1-LOLA",
                                   "DEBY" ~ "S2-DEBY",
                                   "NH-GrtBay" ~ "W5-NH",
                                   "ME-HogIs" ~ "W6-ME"
                                   ))

# get the Q-matrix from snmf results
geno <- read.geno("data/parental_genetics_structure/20250204geno_imputedfile_exp.geno")
snmf_project <- load.snmfProject("data/parental_genetics_structure/20250204geno_imputedfile_exp.snmfProject")
best_run <- which.min(cross.entropy(snmf_project, K = 2))  # choose the best run
Q_matrix <- Q(snmf_project, K = 2, run = best_run)  # extract best run into q-matrix

# pull the site and region labels and merge them with the ancestry proportions
region_labels <- samp_full_subset$ID_SiteDate
region_labels <- as.data.frame(region_labels)
colnames(region_labels) <- "ID_SiteDate"
region_labels <- samp_full_subset[, c("ID_SiteDate", "clean_ID")]
region_labels$Q1 <- Q_matrix[, 1]
region_labels$Q2 <- Q_matrix[, 2]

colnames(site_data)[2] = "ID_SiteDate"

# Merge ancestry proportions into the full data
merged_data <- merge(site_data, samp_full_subset, by = "ID_SiteDate")
merged_data <- merge(region_labels, merged_data, by = "clean_ID", all.x = TRUE)
```

### Make base map
```{r}
# load US coastline 
coastline <- ne_coastline(scale = "medium", returnclass = "sf")

# now plot on the map - create a base map with our coastline as the outline of the plot
base_map <- ggplot(data = coastline) +
  geom_sf() +
  theme_minimal() +
  labs(
    title = "Ancestry of source populations",
    x = "Longitude", y = "Latitude"
  ) +
  coord_sf(xlim = c(-100, -60), ylim = c(24, 50), expand = FALSE)

base_map
```

```{r}
# now make site averages of our ancestry proportions 
site_data_averaged <- merged_data %>%
  group_by(ID_SiteDate.x) %>%
  summarise(Q1_avg = mean(Q1), Q2_avg = mean(Q2),
            Longitude = first(longitudeDecimal),
            Latitude = first(latitudeDecimal))   

# we need to add some arbitrary coordinates for the VA populations or they will all plot on top of each other. let's put them in order from south to north, Deep Water Shoal, DEBY (York Riv), LOLA (Lew Riv)
site_data_averaged[site_data_averaged$ID_SiteDate.x == "W4-VA", "Latitude"] <- 35.61813
site_data_averaged[site_data_averaged$ID_SiteDate.x == "W4-VA", "Longitude"] <- -74.29945
site_data_averaged[site_data_averaged$ID_SiteDate.x == "S2-DEBY", "Latitude"] <- 37.5
site_data_averaged[site_data_averaged$ID_SiteDate.x == "S2-DEBY", "Longitude"] <- -74.95174
site_data_averaged[site_data_averaged$ID_SiteDate.x == "S1-LOLA", "Latitude"] <- 38.8223
site_data_averaged[site_data_averaged$ID_SiteDate.x == "S1-LOLA", "Longitude"] <- -73.19229

map_with_sites <- base_map + 
  geom_scatterpie(
    data = site_data_averaged,
    aes(x = Longitude, y = Latitude, r = 0.9),  
    cols = c("Q1_avg", "Q2_avg"), 
    color = NA,
    pie_scale = 1.5) +  
  scale_fill_manual(name = "Genetic cluster", breaks = c("Q2_avg", "Q1_avg"), labels = c("Atlantic", "Gulf"), values = c("#81C784", "#1565C0")) +  
  theme(
    legend.position = "inside",
    legend.position.inside = c(.3,.7), 
    legend.text = element_text(size = 10),
    panel.grid = element_blank(), 
    panel.background = element_blank(), 
    axis.line = element_line(color = "black"),
    axis.text = element_text(color = "black")
  )

map_with_sites

ggsave("Fig1A_ancestry_map.pdf",
       plot = map_with_sites,
       device = "pdf",
       path = "figures/envr_of_origin",
       height = 4.2,
       width = 6)
```

### Common garden sites inset map
```{r}

# now plot on the map - create a base map with Chesapeake Bay coastline as the outline of the plot
inset_base <- ggplot(data = coastline) +
  geom_sf() +
  theme_minimal() +
  coord_sf(xlim = c(-78, -74), ylim = c(36.5, 39.5), expand = FALSE)+
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank())
inset_base


#Create list of coordinates for Lewisetta and York common garden sites
cg_site <- c("LEW", "YRK")
Latitude <- c(37.98030, 37.249107)
Longitude <- c(-76.46190, -76.497032)

common_garden <- as.data.frame(cbind(cg_site, Latitude, Longitude))

common_garden <- common_garden %>%
  st_as_sf(coords = c('Longitude', 'Latitude'))

# set crs to 4326 for lat/lon
common_garden$geometry <- st_set_crs(common_garden$geometry, 4326)

inset_map <- inset_base +
  geom_point(data = common_garden, aes(x = Longitude, y = Latitude, shape = cg_site, fill = cg_site), size = 4)+
  scale_fill_manual(name = " ", breaks = c("LEW", "YRK"), 
                    values = c("#F06292", "#880E4F"),
                    labels = str_wrap(c("Lewisetta: low salinity and disease, LOLA selection site", "York River: higher salinity and disease, DEBY selection site"), width = 35))+
  scale_shape_manual(name = " ", breaks = c("LEW", "YRK"), 
                    values = c(23, 24),
                    labels = str_wrap(c("Lewisetta: low salinity and disease, LOLA selection site", "York River: higher salinity and disease, DEBY selection site"), width = 35))+
  ggtitle("Common garden sites")+
  scale_x_continuous(breaks = seq(-78, -74, by =1))+
  scale_y_continuous(breaks = seq(36.5, 39.5, by = 1))+
  theme(legend.position = "bottom",
        legend.direction = "vertical",
        legend.text = element_text(size = 9),
        plot.title = element_text(size = 10))

inset_map

ggsave("Fig1A_inset_map.pdf",
       plot = inset_map,
       device = "pdf",
       path = "figures/envr_of_origin",
       height = 3,
       width = 4)
```

