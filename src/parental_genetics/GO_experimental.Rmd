---
title: "GO_experimental.Rmd"
author: "Kiran Bajaj"
output: html_document
date: "2025-02-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#setwd("~/Desktop/MVP-H2F-HatcheryField")
```

### Packages

```{r}

library(tidyverse)
library(dplyr)
library(readr)
library(grid)
library(colorspace)

```

### Load data

```{r}

# Fst outliers generated by OutFLANK (using a q value of 0.01)
outflank_output <- read_csv(file.path("..", "..", "data", "putative_selection", "outflank_results.csv"))

```

### Gene enrichment

#### Data preparation

```{r}

test <- outflank_output %>%
  filter(OutlierFlag == TRUE) %>%
  filter(!is.na(cust_gene_id))

```

```{r}

# filter for SNPs with available gene info to put into ShinyGO

annotated_only <- outflank_output %>% # starts at 154102 rows
  arrange(qvalues) %>% # sort by q value
  filter(!is.na(cust_gene_id)) %>% # down to 21610 with gene info available
  filter(!is.na(cust_gene_name)) %>%
  rename(gene = cust_gene_id)

```

```{r}

# i'm interested in getting more annotations for this genome since only 21610 out of 154102 SNPs are annotated in the dataframe that we got from the sequencing facility. 

# install relevant packages
#BiocManager::install(c("rtracklayer", "GenomicRanges"))

library(rtracklayer)
library(GenomicRanges)
library(dplyr)

# same code as above but don't filter for annotated SNPs this time
snp_df <- outflank_output %>% # starts at 154102 rows
  arrange(qvalues) # sort by q value

# download the gff3 annotation from Ensembl, save it somewhere, and import it here
# download link: https://metazoa.ensembl.org/Crassostrea_virginica_gca002022765v4/Info/Index

gff <- rtracklayer::import(file.path("..", "..", "data", "putative_selection", "Crassostrea_virginica_gca002022765v4.C_virginica_3.0.62.gff3"))

```

```{r}

# our SNP dataframe uses numbers 1-10 for chromosomes but the gff3 object has a different naming scheme - we need to make these match
snp_df$scaffold <- dplyr::case_when(
  snp_df$Chromosome == 1 ~ "CM008241.1",
  snp_df$Chromosome == 2 ~ "CM008242.1",
  snp_df$Chromosome == 3 ~ "CM008243.1",
  snp_df$Chromosome == 4 ~ "CM008244.1",
  snp_df$Chromosome == 5 ~ "CM008245.1",
  snp_df$Chromosome == 6 ~ "CM008246.1",
  snp_df$Chromosome == 7 ~ "CM008247.1",
  snp_df$Chromosome == 8 ~ "CM008248.1",
  snp_df$Chromosome == 9 ~ "CM008249.1",
  snp_df$Chromosome == 10 ~ "CM008250.1"
)

# filter for rows with position info - we need this for reannotation
snp_df <- snp_df %>%
  filter(!is.na(Position)) # none removed

# turn info from our SNP data frame into a GenomicRanges object - stores genomic coordinates in a standardized way
snp_gr <- GRanges(
  seqnames = snp_df$scaffold,
  ranges = IRanges(start = snp_df$Position, end = snp_df$Position),
  snp_id = snp_df$LocusName
)

# filter to get just the gene entries in the gff3 file (the file includes everything like mRNA, exons, etc.)
gene_features <- gff[gff$type == "gene"]

# find overlaps between our SNPs and genes in gff3 file
hits <- findOverlaps(snp_gr, gene_features)

# create an annotation data frame
annotated <- data.frame(
  snp_id = snp_gr$snp_id[queryHits(hits)],
  gene_id = mcols(gene_features)$ID[subjectHits(hits)]
)

# merge annotation data frame back with original 
snp_annotated <- left_join(snp_df, annotated, by = c("LocusName" = "snp_id"))

print(sum(!is.na(snp_annotated$gene_id))) # 113878 SNPs of 151258 now annotated with gene IDs

```

```{r}

# we now have way more gene IDs filled in. the next step is to connect to Ensembl online to query for biological information about our new gene IDs.

library(biomaRt)

# connect to the Ensembl Metazoa databse
mart <- useEnsemblGenomes(
  biomart = "metazoa_mart", 
  dataset = "cvgca002022765v4_eg_gene", # this is the code for the genome we want
  host = "https://metazoa.ensembl.org"
)

# clean up the annotated SNP data frame 
snp_annotated$gene_id <- as.character(snp_annotated$gene_id)
# remove the "gene:" prefix from new gene_id values
snp_annotated$gene_id <- sub("^gene:", "", snp_annotated$gene_id)
# remove NAs as before
gene_ids <- unique(na.omit(snp_annotated$gene_id))

# query Ensembl Metazoa for the information we want. attributes = columns to grab, filters = how you want to search, values = our gene IDs, mart = database connection
annotations <- getBM(
  attributes = c("ensembl_gene_id", "description", "go_id", "name_1006"),
  filters = "ensembl_gene_id",
  values = gene_ids,
  mart = mart
)

# ensembl_gene_id: the official Ensembl gene ID
# description: functional description
# go_id: Gene Ontology ID
# name_1006: name/definition of the GO term

# this creates a longer than expected data frame because it's creating a new row for every GO term - so SNPs appear in the df more than once. I want to collapse this.

annotations_collapsed <- annotations %>%
  group_by(ensembl_gene_id, description) %>%
  summarise(
    go_id = list(unique(na.omit(go_id))),
    go_term = list(unique(na.omit(name_1006))),
    .groups = "drop"
  )

# Now join this to SNPs (each SNP keeps its gene associations)
snp_annotated <- snp_annotated %>%
  left_join(annotations_collapsed, by = c("gene_id" = "ensembl_gene_id"))

```

### Data product: annotated SNP dataframe

```{r}

snp_annotated_sharing <- snp_annotated %>%
  select(Affx.ID:go_term)

write_csv(snp_annotated_sharing, file.path("..", "..", "supp files"))

```

### Table product: Dermo resistance genes

```{r}

# list of putative Dermo resistance genes from Wang et al. 2025 10.2983/035.044.0108
gene_list <- c(
  "LOC111118916", "LOC111121781", "LOC111121782", "LOC111117973", "LOC111123901",
  "LOC111124277", "LOC111124319", "LOC111122703", "LOC111122700", "LOC111123748",
  "LOC111123431", "LOC111123196", "LOC111127997", "LOC111130709", "LOC111129507",
  "LOC111137292", "LOC111132556", "LOC111134468", "LOC111101514", "LOC111101533",
  "LOC111101234", "LOC111104654", "LOC111105403", "LOC111103311", "LOC111103990",
  "LOC111103375", "LOC111110409", "LOC111107154", "LOC111108295", "LOC111106182",
  "LOC111108376", "LOC111113499", "LOC111113290", "LOC111115720", "LOC111115227",
  "LOC111114164", "LOC111116247"
)

# Filter and select columns
dermo_loci <- snp_annotated %>%
  filter(gene_id %in% gene_list) %>%
  select(LocusName, FST, OutlierFlag, chrom_position, gene_id, description) %>%
  filter(OutlierFlag == TRUE)

write.table(dermo_loci, pipe("pbcopy"), sep = "\t", row.names = FALSE, quote = FALSE)
write.csv(dermo_loci, file.path("..", "..", "supp files", "dermo_loci.csv"), row.names = FALSE)


```

```{r}

# Check for SNPs mapping to multiple genes
snp_gene_counts <- snp_annotated %>%
  filter(!is.na(gene_id)) %>% # goes down to our annotated set of 110455
  group_by(LocusName) %>%
  summarise(num_genes = n_distinct(gene_id)) %>%
  filter(num_genes > 1) # number of genes > 1 = 2414, number of genes > 2 = 46, number of genes > 3 = 1. 
                        # 2414 + 46 + 1 = 2461

dim(snp_gene_counts)  # this should be 2461, because we have 156563 in the reannotated set and 154102 in the original set

dim(snp_annotated)

```

```{r}

# generate list for ShinyGO - outliers only

snp_annotated_shinygo <- snp_annotated %>%
  filter(OutlierFlag == TRUE) %>%
  filter(!is.na(gene_id))    

shinygo_genes <- paste(unique(snp_annotated_shinygo$gene_id), collapse = " ")
shinygo_genes # print list to copy and paste into ShinyGO

length(unique(snp_annotated_shinygo$gene_id)) # this is 1634 unique genes

```

```{r}

# look at the specific loci with high Fst, what genes are they in?
snp_annotated_outliers <- snp_annotated %>%
  filter(OutlierFlag == TRUE) %>%
  arrange(desc(FST)) %>%                     # sort by Fst descending
  select(LocusName, FST, gene_id, description)      # keep only SNP ID, Fst, and gene name

length(unique(snp_annotated_outliers$LocusName)) # this is 6928 unique loci, with some repeats (data frame = 6981 rows)

write_csv(snp_annotated, file.path("..", "..", "data", "putative_selection", "outlier_SNPs.csv"))

```

#### ShinyGO

- Go to the ShinyGO website (ShinyGO)[https://bioinformatics.sdstate.edu/go/]
- Paste the list of genes above into the box on the left
- Press "Change species", type in crassostrea virginica, and choose: "cvirginica.3.0_eg_gene"
- Keep all other settings as default values and press submit
- On the "Enrichment" tab, download the top pathways
- On the "Genes" tab, download the gene info table

### Plotting

- Enriched: One row per enriched pathways. Corresponding genes in a column together, separated by spaces.
- Genes: One row per gene. Chromosome positions and additional details.

```{r}

# load in outputs from ShinyGO

# this one is the enriched pathways and the genes that go with them
enriched <- read_csv(file.path("..", "..", "data", "putative_selection", "shinyGO_enriched.csv"))

# this one is all the genes that matched the database and info about them
genes <- read_csv(file.path("..", "..", "data", "putative_selection", "shinyGO_genes.csv"))

```

#### Data preparation

```{r}

# prepare data
manhattan_fst <- snp_annotated %>%
  filter(He > 0.1) %>%  # filter based on heterozygosity - goes down to 151340 SNPs
  mutate(
    Chromosome = as.numeric(Chromosome),
    Position = as.numeric(Position),
    qvalues = as.numeric(qvalues),
    FST = ifelse(FST < 0, 0.00001, FST),  # assign small value to negative FST
    Outlier = ifelse(qvalues < 0.01, "outlier", "nonoutlier"), # outliers are designated with q values 
    Color = ifelse(
      Outlier == "nonoutlier",
      ifelse(Chromosome %% 2 == 1, "#8c9bad", "#a5b7cc"),  # base color
      lighten(ifelse(Chromosome %% 2 == 1, "#8c9bad", "#a5b7cc"), 0.4) # lighten for outliers
    )
  )
# compute chromosome lengths and cumulative positions for plotting
chromosome_lengths <- manhattan_fst %>%
  group_by(Chromosome) %>%
  summarise(chr_len = max(Position)) %>%
  mutate(tot = cumsum(lag(chr_len + 1e7, default = 0))) # add a buffer between chromosomes for readability

# merge cumulative positions back into the data
manhattan_fst <- left_join(manhattan_fst, chromosome_lengths, by = c("Chromosome" = "Chromosome")) %>%
  arrange(Chromosome, Position) %>%
  mutate(Cumulative_Position = Position + tot)

# create axis ticks for chromosome labels
chrom_ticks <- manhattan_fst %>%
  group_by(Chromosome) %>%
  summarize(center = (max(Cumulative_Position) + min(Cumulative_Position)) / 2)

```

These data need to be reshaped. The OutFLANK data product has loci in rows, and genes IDs, brief functional annotations, chromosomes, and chromosome positions in columns. The "enriched" csv has pathways in rows, and a list of genes separated by spaces in one column that need to be split. The "genes" csv has genes in rows, and positions and bunch of other stuff in columns. We should check these positions with the OutFLANK positions (they might come from the same place so should be the same). 

```{r}

# split up the genes column so there is one row per gene
enriched_split <- enriched %>%
  mutate(gene = strsplit(as.character(Genes), " ")) %>%
  unnest(gene) %>%
  dplyr::select(-URL, -Genes)

# rename gene column for merge
genes <- genes %>%
  rename(gene = Pasted)

# join enriched pathway genes with full gene info from the other dataframe
enriched_joined <- enriched_split %>%
  inner_join(genes, by = "gene")

manhattan_fst <- manhattan_fst %>%
  rename(gene = cust_gene_id)

# join enriched pathway genes with Outflank output data
enriched_fully_joined <- manhattan_fst %>%
  inner_join(enriched_joined, by = "gene") %>%
  select(LocusName, `Enrichment FDR`, nGenes, `Pathway Genes`, `Fold Enrichment`, Pathway) %>%
  mutate(
    # extract GO_id
    GO_id = str_extract(Pathway, "^GO:\\d+"),
    # assign gene_type based on GO term grouping
    gene_type = case_when(
      GO_id %in% c("GO:0003700", "GO:0006355", "GO:0043565", "GO:0005634") ~ 
        "Transcription and gene regulation",
      GO_id %in% c("GO:0055085", "GO:0022857", "GO:0070588", "GO:0016020", "GO:0016021") ~ 
        "Membrane and ion transport",
      GO_id %in% c("GO:0007165", "GO:0004672", "GO:0006468", 
                   "GO:0004930", "GO:0007186", "GO:0009190", "GO:0008083") ~ 
        "Signal transduction and kinase activity",
      GO_id %in% c("GO:0030286", "GO:0008569") ~ 
        "Motor and cytoskeleton function",
      GO_id %in% c("GO:0005524", "GO:0110165") ~ 
        "Binding and general cell structure",
      TRUE ~ "Other"
    )
  )

```

#### Manhattan plot

```{r}

# this is all the data we need for the manhattan plot
library(dplyr)
library(ggplot2)
library(ggrepel)

merged_manhattan <- manhattan_fst %>%
  left_join(enriched_fully_joined, by = "LocusName")

# outlier threshold
threshold_fst <- min(merged_manhattan$FST[merged_manhattan$qvalues < 0.01], na.rm = TRUE)

# genes to highlight + y text positions
gene_labels <- tibble(
  gene_id = c("LOC111118916", "LOC111122700", "LOC111110350", "LOC111130444"),
  label = c("Myosin (LOC111118916)",
            "Advillin (LOC111122700)",
            "Voltage-dependent calcium channel (LOC111110350)",
            "Organic cation transporter protein-like (LOC111130444)"),
  y_pos = c(0.90, 0.85, 0.84, 0.88),
  slant = c(-70000000, -60000000, 50000000, 60000000)
)

# subset SNPs to highlight
highlight_snps <- merged_manhattan %>%
  filter(Outlier == "outlier", gene_id %in% gene_labels$gene_id)

# pick one top SNP per gene for label placement
label_points <- highlight_snps %>%
  group_by(gene_id) %>%
  slice_max(order_by = FST, n = 1) %>%
  left_join(gene_labels, by = "gene_id")

# base manhattan plot
ggplot_manhattan <- ggplot(merged_manhattan, aes(x = Cumulative_Position, y = FST)) +

  # background points
  geom_point(aes(color = Color), size = 1, shape = 16, alpha = 1) +

  # highlighted GO category points
  geom_point(
    data = merged_manhattan %>% filter(!is.na(gene_type) & Outlier == "outlier"),
    aes(color = case_when(
      gene_type == "Transcription and gene regulation" ~ "#3e4989",
      gene_type == "Membrane and ion transport" ~ "#440154",
      gene_type == "Signal transduction and kinase activity" ~ "#fde725",
      gene_type == "Motor and cytoskeleton function" ~ "#7b3294",
      gene_type == "Binding and general cell structure" ~ "#35b779"
    )),
    size = 2
  ) +

  # circles around specific genes' SNPs
  geom_point(
    data = highlight_snps,
    aes(x = Cumulative_Position, y = FST),
    shape = 21, fill = NA, color = "black", size = 3, stroke = 0.8
  ) +
  geom_segment(
  data = label_points,
  aes(
    x = Cumulative_Position,
    xend = Cumulative_Position + slant, 
    y = FST,
    yend = y_pos + 0.08  # make segment end at the label y
  ),
  color = "black",
  size = 0.4
) +
geom_text(
  data = label_points,
  aes(
    x = Cumulative_Position + slant,
    y = y_pos + 0.11,
    label = label
  ),
  color = "black",
  size = 4
) +

  # rest of plot setup
  scale_x_continuous(breaks = chrom_ticks$center, labels = chrom_ticks$Chromosome) +
  scale_color_identity(guide = "none") +
  labs(x = "Chromosome", y = expression(F[ST])) +
  geom_hline(aes(yintercept = threshold_fst, linetype = "q < 0.01"), color = "black") +
  scale_linetype_manual(name = "Outlier threshold", values = c("q < 0.01" = "dashed")) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, color = "black"),
    panel.grid.major = element_blank(),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14)
  )

# save
ggsave(file.path("..", "..", "figures", "putative_selection", "fst_manhattan_plot.pdf"),
       ggplot_manhattan, width = 15, height = 6, dpi = 300)



```

#### Lollipop plot

```{r}

# assign colors for GO categories
color_mapping <- c(
  "Transcription and gene regulation" = "#3e4989",
  "Membrane and ion transport" = "#440154",
  "Signal transduction and kinase activity" = "#fde725",
  "Motor and cytoskeleton function" = "#7b3294",
  "Binding and general cell structure" = "#35b779"
)

# lollipop plot
lollipop_plot <- ggplot(enriched_fully_joined, aes(x = `Fold Enrichment`, 
                                  y = reorder(Pathway, `Fold Enrichment`), 
                                  color = gene_type, 
                                  size = nGenes)) +
  geom_segment(aes(x = 0, xend = `Fold Enrichment`,  # set lengths of the segments
                   y = Pathway, yend = Pathway), 
               linewidth = 0.8) +  # width of the segments
  geom_point() +  # circles
  scale_color_manual(values = color_mapping) +  # assign colors
  scale_size_continuous(range = c(2, 5)) +  # adjust circle size range
  # set limits of the x scale to adjust to the length of the segments
  scale_x_continuous(expand = c(0, 0), limits = c(0, max(enriched_fully_joined$`Fold Enrichment`) * 1.1)) +  
  theme_bw() +
  theme( 
    axis.text = element_text(color = "black", size = 14),  # make axis text black
    panel.grid.major.x = element_blank(), # remove grid lines
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    axis.title = element_text(size = 16),    
    legend.title = element_text(size = 14),      
    legend.text = element_text(size = 13)
  ) +
  labs(x = "Fold enrichment", y = "Pathway", size = "Number of genes", color = "Pathway type") +
  guides( # customize shapes and colors of symbols on legend with an override
    color = guide_legend(override.aes = list(linetype = "blank", size = 3)),  
    size = guide_legend(override.aes = list(linetype = "blank", shape = 21, fill = "slategrey",
                                            color = "slategrey"))  
  )

# save figure
ggsave(file.path("..", "..", "figures", "putative_selection", "GO_lollipop_plot.pdf"), 
       lollipop_plot, width = 14, height = 6, dpi = 300)

lollipop_plot

```