---
title: "Envr_Genetics_Length_Survival_Hatchery"
output: pdf_document
date: "2025-02-20"
---

This code analyzes the effect of conditions in the environments-of-origin and parent genetics on offspring oyster survival and shell length in the VIMS ABC hatchery and nursery.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("~/Desktop/GitHub/MVP-H2F-HatcheryField/src/parent_effects_H2F")
```

### Load packages
```{r}
library(tidyverse)
library(car)
library(ggplot2)
library(gridExtra)
library(multcompView) #extract significance letters from Tukey-Kramer test
library(cowplot) #arrange ggplots
library(ggpmisc)
library(vegan) #for Mantel tests
library(broom)#save lm results to tibbles
library(corrplot)
library(viridis) #viridis color scheme
library(ggstance) #for vertical position dodge function
```

### Load data
```{r}
#this file contains raw lengths of all oysters aged 15-78 days
length <- read.csv(file.path("../../data/performance_H2F/latestage_length.csv"))

#this file has 0.1 and 0.9 quantiles for temperature and salinity for the 8 groups
quantiles <- read.csv("../../data/environment/quantiles_05232025.csv")[, -c(1,9)]

#this file contains survival rate data for larval oysters up to day 21 post hatching
survival <-  read.csv("../../data/performance_H2F/CViMVP_larvae_survival.csv")

#this file contains data on mean heterozygosity and allelic richness in the parent populations
parent_genetics <- read.csv("../../data/parent_effects_H2F/parent_genetic_effects.csv")
```

### Survival Data Prep
```{r}
#For survival rates, we only care about survival from day 21 (marked as day_an 15-21), so select those only. Reminder that days 15-21 were grouped for analysis because there were constant larval drops occurring during that time as individuals reached the eyed stage, but the number of drops varied by site_name. Exclude LARMIX, since it has no environmental data.
surv21 <- survival %>% 
  filter(Day_analysis == "15-21") %>% 
  filter(Tank_naming != "MVP-LARMIX")

#Exclude any groups with "small" in their label. The length data only considers the eyed oysters.
small <- grep("small", surv21$Group_Day_Label, ignore.case = TRUE)

#make new dataframe WITHOUT any indices saved in small
surv21_sub <- surv21[-small, ]

#replace JR with updated group name "VA"
surv21_sub["Tank_naming"][surv21_sub["Tank_naming"] == "MVP-JR"] <- "MVP-VA"

#exclude "MVP" from group names and add in W or S labels
groups <- c(unique(surv21_sub$Tank_naming))
wild <- substring(groups[c(2,1,6,5,4,3)], 5)
w_label <- paste(paste("W", 1:6,  sep = ""), wild, sep = "-")

for(x in wild){
    surv21_sub["Tank_naming"][surv21_sub["Tank_naming"] == paste("MVP", x, sep = "-")] <- w_label[grep(x, w_label)]
}

#rename selection line sites to include S1-S2 labels
selection <- substring(groups[7:8], 5)
s_label <- paste(paste("S", 1:2, sep = ""), selection, sep = "-")

for(x in selection){
    surv21_sub["Tank_naming"][surv21_sub["Tank_naming"] == paste("MVP", x, sep = "-")] <- s_label[grep(x, s_label)]
}

#select only tank naming and survival rate columns
survival_filter <- surv21_sub[, c("Tank_naming", "Survival_rate_perc")]

#rename columns
colnames(survival_filter) <- c("site_name", "percent_survival")
```

### Length data prep
```{r length_cleaning_means}
#select columns with site name, day, and shell length in mm
length_sub <- length[,c("site_name", "day_an", "shell_length_mm")]

colnames(length_sub) <- c("site_name", "day_an", "length")

#filter out LARMIX from group
length_filter <- length_sub %>% 
  filter(site_name != "H1-HYBRIDMIX") %>% 
  mutate(site_name = fct_relevel(site_name, c("W1-TX", "W2-LA", "W3-FL", "S1-LOLA", "S2-DEBY", "W4-VA", "W5-NH", "W6-ME")))

#make data frame for day 21 length
length_21 <- length_filter %>% 
  filter(day_an == "15-21")

#make data frame for day 78 length
length_78 <- length_filter %>% 
  filter(day_an == "78")
```

### Environmental data prep
```{r}
#Replace underscores in site names with hyphens
quantiles$site_name <- str_replace(quantiles$site_name, "_", "-")

colnames(quantiles) <- c("site_name", "sal10", "sal90", "sal_sd", "temp10", "temp90", "temp_sd")

#filter out YRK and LEW from quantiles
quant_eoo <- quantiles %>% 
  filter(site_name != "YRK" & site_name != "LEW")
#filter only for YRK and LEW
quant_field <- quantiles %>% 
  filter(site_name == "YRK" | site_name == "LEW")
```

###Genetics data prep
```{r parent_genetics_cleaning}
#rename column names 
colnames(parent_genetics) <- c("site_name", "ho", "avg_expected_hs", "ar")
```

###Data product: H_Survival_Envr_Genetics.csv
```{r surv_join_dfs}
#make df of just genetic and envr data
envr_gen <- left_join(quant_eoo, parent_genetics, by = "site_name")

#merge survival data with genetic and environmental data
surv_merge <- left_join(survival_filter, envr_gen, by = "site_name")

write.csv(surv_merge, "../../data/parent_effects_H2F/H_Survival_Envr_Genetics.csv", row.names = FALSE)
```

#Join length day 21, genetic, and envr data frames
```{r len21_join_dfs}
len_envr_gen <- merge(envr_gen, length_filter, by = c("site_name"))

len21_envr_gen <- len_envr_gen %>% 
  filter(day_an == "15-21")

len78_envr_gen <- len_envr_gen %>% 
  filter(day_an == "78")

#Sanity check- make sure row numbers match between the original length_21 and length_78 data frames and the new ones with the added columns
nrow(len21_envr_gen) #nrow = 619
nrow(length_21) #nrow = 619
nrow(len78_envr_gen) #nrow = 971
nrow(length_78) #nrow = 971

#make site_name a character
len21_envr_gen$site_name <- as.character(len21_envr_gen$site_name)
len78_envr_gen$site_name <- as.character(len78_envr_gen$site_name)

write.csv(len21_envr_gen, "../../data/parent_effects_H2F/H_Length21_Envr_Genetics.csv", row.names = FALSE)

write.csv(len78_envr_gen, "../../data/parent_effects_H2F/H_Length78_Envr_Genetics.csv", row.names = FALSE)
```

#Check for multicollinearity among explanatory variables
```{r multicollinearity}
par(mfrow = c(1,1))
cor_matrix <- cor(envr_gen[,c("temp10", "temp90", "sal10", "sal90", "ho", "ar")])

#rename rows and columns
colnames(cor_matrix) <- c("Temp 0.1 quantile", "Temp 0.9 quantile", "Salinity 0.1 quantile", "Salinity 0.9 quantile", "Heterozygosity", "Allelic Richness")
rownames(cor_matrix) <- c("Temp 0.1 quantile", "Temp 0.9 quantile", "Salinity 0.1 quantile", "Salinity 0.9 quantile", "Heterozygosity", "Allelic Richness")
#for supplemental material, rename variables for a cleaner graph (temp 0.1 quantile, temp 0.9 quantile, salinity 0.1 quantile, salinity ..., heterozygosity, allelic richness)

pdf(file = "../../figures/supplement/EOO_Envr_Genetics_Corrplot.pdf")
corrplot_eoo <- corrplot(cor_matrix,
         method = "color",
         type = "upper",
         tl.col = "black",
         tl.srt = 45,
         title = "EOO Variable Multicollinearity",
         addCoef.col = 'black',
         mar=c(0,0,2,0))
dev.off()

corrplot_eoo
#temp quantile 90 is collinear with Ho (r = 0.74) and ar (r = 0.76). Salinity quantile 10 is borderline collinear with ho (-0.69). Remove temp quantile 90 and check VIF.

#calculate variance inflation factor (VIF)- create VIF function
VIF <- function(a, b, c, d, e){
  1/(1-summary(lm(a ~ b + c + d + e))$r.squared)
}

#get VIF for temp quantile 10
VIF(envr_gen$temp10, envr_gen$sal10, envr_gen$sal90, envr_gen$ho, envr_gen$ar)
#VIF temp10 = 2.82

VIF(envr_gen$sal10, envr_gen$sal90, envr_gen$ho, envr_gen$ar, envr_gen$temp10)
#VIF sal10 = 2.47

#VIF for salinity quantile 90
VIF(envr_gen$sal90, envr_gen$ho, envr_gen$ar, envr_gen$temp10, envr_gen$sal10)
#VIF_sal90 = 2.78

#VIF for ho
VIF(envr_gen$ho, envr_gen$ar, envr_gen$temp10, envr_gen$sal10, envr_gen$sal90)
#VIF_ho = 4.04

#VIF for average allelic richness
VIF(envr_gen$ar, envr_gen$temp10, envr_gen$sal10, envr_gen$sal90, envr_gen$ho)
#VIF_ar = 1.81
```

The next chunk includes multiple regressions testing the effects of several environmental and genetic parameters on length and survival in the hatchery/nursery. The explanatory variables are 1) salinity quantile 10, 2) salinity quantile 90, 3) temperature quantile 10, 4) mean observed heterozygosity in the parent oysters from each site (Ho), and 5) mean allelic richness (AR) in the parent oysters from each site.

#Day 21 Length: Multiple regression
```{r}
len21_lm <- lm(length ~ temp10 + sal10+ sal90 + ho + ar, data = len21_envr_gen)
len21_resid <- len21_lm$residuals
shapiro.test(len21_resid) #p = 1.8e-8, data are not normal, 
#plot(len21_lm) #no outliers, homoscedasticity looks good
summary(len21_lm) #everything is significant. Model stats: Adj. R squared = 0.2354, F = 39.05, p < 2.2e-16

#there's one exceptionally low length from the TX group that is throwing off normality, I'm going to exclude it and try the models
len21_envr_gen_sub <- len21_envr_gen %>% 
  filter(length > 0.22)

#I am using the data excluding the one very low length measurement.
len21_lm2 <- lm(length ~ temp10 + sal10+ sal90 + ho + ar, data = len21_envr_gen_sub)
len21_resid2 <- len21_lm2$residuals
shapiro.test(len21_resid2) #p = 8.64e-5, data are not normal, but improved, multiple regressions are pretty robust to non-normality
#plot(len21_lm2) #no outliers, homoscedasticity looks good
summary(len21_lm2) #everything is significant. Model stats: Adj. R squared = 0.22, F = 45.49 on 4 and 613 DF, p < 2.2e-16

#model selection
drop1(len21_lm2) #this is the model with the lowest AIC (-5137.9)

len21_lm2_scaled <- lm(scale(length) ~ scale(temp10) + scale(sal10) + scale(sal90) + scale(ho) + scale(ar), data = len21_envr_gen_sub)
summary(len21_lm2_scaled)
```

#Day 78 Length: Multiple regression and model selection 
```{r day78_lm}
#using all data for day 78
#day 78 multiple regression
len78_lm <- lm(length ~ temp10 + sal10+ sal90 + ho + ar, data = len78_envr_gen)
len78_resid <- len78_lm$residuals
shapiro.test(len78_resid) #p = 0.00092, data not normal, but not bad
#plot(len78_lm) #no outliers, homoscedasticty is good
summary(len78_lm) #all significant except sal90
#model stats: Adj. R squared = 0.266, F = 71.22 on 5 and 965 df, p < 2.2e-16

#model selection
drop1(len78_lm) #drop sal90

len78_lm2 <- lm(length ~ temp10 + sal10+ ho + ar, data = len78_envr_gen)
len78_resid2 <- len78_lm2$residuals
shapiro.test(len78_resid2) #p = 0.00098, data not normal, but not bad
#plot(len78_lm2) #no outliers, homoscedasticty is good
summary(len78_lm2) #all significant
#model stats: Adj. R squared = 0.266, F = 88.86 on 4 and 966 df, p < 2.2e-16

len78_lm_scaled <- lm(scale(length) ~ scale(temp10) + scale(sal10)+  scale(ho) + scale(ar), data = len78_envr_gen)
summary(len78_lm_scaled)
```

#Day 21 Survival: Multiple Regression
I don't think this model is worth running, too few data points, many outliers, not homoscedastic, but I'll leave it here for now for reference.
```{r day21_surv_lm}
#day 21 survival multiple regression
surv_lm <- lm(percent_survival ~ temp10 + sal10+ sal90 + ho + ar, data = surv_merge)
surv_resid <- surv_lm$residuals
shapiro.test(surv_resid) #p = 0.4449, normal
#plot(surv_lm) # 3 outliers
summary(surv_lm) #nothing signif

#model selection
drop1(surv_lm) #drop sal90

#rerun model without ho
surv_lm2 <- lm(percent_survival ~ temp10 + sal10+ ho + ar, data = surv_merge)
summary(surv_lm2) #temp10, sal10 signif
#model stats: adj. R squared = 0.8513, F = 11.02 on 4 and 3 DF, p = 0.039
drop1(surv_lm2) #dropping nothing at this point results in the lowest AIC, stop model selection now.

```

#### Plot of slopes
```{r}
#save slopes from each model to one data frame
slopes <- rbind(tidy(len21_lm2_scaled), tidy(len78_lm_scaled))
#add column for time point
slopes$t <- c(rep(c("15-21"), 6), rep(c("78"), 5))

#add dummy row for time point lacking variable so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
slopes[nrow(slopes) + 1,] = list("scale(sal90)", -.1, .01, NA, NA, "78")

#rename columns
colnames(slopes) <- c("explanatory", "slope", "se", "Fstat", "pval", "t")

#remove rows with Intercept slopes
slopes_df <- slopes %>% 
  filter(explanatory != "(Intercept)")

slopes <- slopes_df %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "black", size = 3.5, position = position_dodge2v(height = .75, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "black", height = 0, size = 1, position = position_dodgev(height = -.75, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("15-21" = .5, "78" = 1), labels = c("15-21" = "End hatchery", "78" = "End nursery"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("15-21" = 15, "78" = 16), labels = c("15-21" = "End hatchery", "78" = "End nursery"))+
  xlim(c(-1,2))+
  ggtitle(str_wrap(c("Slopes of Genetic Variables and Env. Quantiles vs. Survival"), width = 50))+
  labs(subtitle = "End of hatchery (days 15-21) and nursery (day 78) stages")+
  xlab("Slope on Scaled Data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory Variable", 
                   limits = c("scale(sal10)", "scale(sal90)", "scale(temp10)", "scale(ho)", "scale(ar)"), 
                   labels = c("Salinity 0.1 quantile", "Salinity 0.9 quantile", "Temp 0.1 quantile",  str_wrap(c("Heterozygosity/ Temp 0.9 quantile"), width = 17), str_wrap(c("Allelic richness/ Temp 0.9 quantile"), width = 20)))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 12),
        axis.title = element_text(size = 13),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13),
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 13))

slopes

ggsave("slope_hatchery_nursery.pdf",
       plot = slopes,
       device = "pdf",
       path = "../../figures/parent_effects_H2F",
       height = 4,
       width = 7)

```
