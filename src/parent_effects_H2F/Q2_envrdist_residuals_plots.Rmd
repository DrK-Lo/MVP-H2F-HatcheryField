---
title: "Q2_envrdist_residuals_plots"
authors: "Camille Rumberger, Nicole Mongillo"
date: "2025-08-20"
output: pdf_document
---

This file compares survival and length of each treatment group at each common garden site to environmental distance from their environment-of-origin to the common garden environment. We found that groups from EoOs with less extreme cold temperatures have higher survival in the field experiment. Therefore, we are testing the hypothesis that the southern sites (W1-TX, W2-LA, W3-FL) are driving the positive relationship between environmental distance and survival. 

NM initially created 6 figure panels for of survival vs. environmental distance. CR then plotted the residuals of the multiple regression models from Q2 to see which sites are driving the positive relationships - this is now Fig S9. 

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory relative to project root
knitr::opts_knit$set(root.dir = here::here())

if (!require("pacman")) install.packages("pacman")

packages <- c("tidyverse", "here", "ggplot2", "stringr")
pacman::p_load(char = packages)

# log versions for reproducibility
r_version <- paste(R.version$major, R.version$minor, sep = ".")
lib_ver <- packages %>%
  map_chr(~ paste0(.x, " (v", packageVersion(.x), ")")) %>%
  paste(collapse = ", ")
```

```{r}
getwd()
```

## Read in data
```{r}

# read in data
surv_mod_ord_rename <- read.csv("data/performance_H2F/field_surv_all_times.csv")[, -1]

#environmental distance based on scaled envr quantiles
env_dist <- read.csv("results/environment/envr_quantiles_dist_all.csv")

# residuals of models looking at env dist/gen vs survival (without dist)
resid_surv <- read.csv("results/parent_effects_H2F/residuals_distance_vs_surv.csv")
resid_len <- read.csv("results/parent_effects_H2F/residuals_distance_vs_length.csv")
```

## Data preparation
### Clean data and create merged data frame
```{r}
#remove H1-HYBRIDMIX and H2-SEEDMIX from survival
surv_sub <- surv_mod_ord_rename %>% 
  filter(pop != "H1-HYBRIDMIX" & pop!= "H2-SEEDMIX")

#keep only columns for environmental distance to LEW and YRK, exclude rows where common garden sites are compared to themselves
env_dist_cg <- env_dist[1:8, c(1, 10:11)]
colnames(env_dist_cg) <- c("pop", "dist_LEW", "dist_YRK")

#find mean survival for each pop at each monitoring event at each cg site
surv_means <- aggregate(surv_mod_ord_rename$surv, by = list(surv_mod_ord_rename$pop, surv_mod_ord_rename$bag_site, surv_mod_ord_rename$t), FUN = mean)

colnames(surv_means) <- c("pop", "bag_site", "t", "mean_surv")

#merge surv and environmental distance data
surv_dist_means <- merge(surv_means, env_dist_cg, by = "pop")

surv_dist_means$t <- as.character(surv_dist_means$t)

surv_dist_means$pop <- factor(surv_dist_means$pop, levels = c("W1-TX", "W2-LA", "W3-FL", "W4-VA", "S1-LOLA", "S2-DEBY",  "W5-NH", "W6-ME"))
```

##Survival vs. environmental distance (Fig S9 OLD) 

KEB edited to just define plotting settings once and change as needed. 

```{r}
# shared plot settings
site_config <- list(
  Lewisetta = list(dist_col = "dist_LEW", label = "Lewisetta"),
  YorkRiver = list(dist_col = "dist_YRK", label = "York River")
)

time_labels <- c("1" = "November 2023", "2" = "May 2024", "3" = "November 2024")

# function to create a single plot
make_surv_plot <- function(data, site, t_val) {
  cfg <- site_config[[site]]
  
  data %>%
    filter(bag_site == site, t == t_val) %>%
    ggplot(aes(x = .data[[cfg$dist_col]], y = mean_surv)) +
    geom_point(aes(shape = pop), size = 2.5) +
    scale_shape_manual(name = "EOO", values = c(15, 16, 17, 18, 4, 3, 7, 10)) +
    ylim(c(0, 1)) +
    ggtitle(str_wrap(paste0("Survival vs. environmental distance (EOO to ", cfg$label, ")"), width = 35)) +
    labs(subtitle = time_labels[t_val]) +
    xlab(paste0("Environmental distance (EOO to ", cfg$label, ")")) +
    ylab("% Survival") +
    theme_classic() +
    theme(
      panel.grid.major = element_line(color = "grey90"),
      axis.text = element_text(color = "black"),
      plot.subtitle = element_text(color = "black")
    )
}

# generate all plots
plots <- list()
for (site in names(site_config)) {
  prefix <- ifelse(site == "Lewisetta", "L", "Y")
  for (t_val in c("1", "2", "3")) {
    name <- paste0(prefix, "surv_dist_t", t_val)
    plots[[name]] <- make_surv_plot(surv_dist_means, site, t_val)
    print(plots[[name]])
  }
}

# Save all plots
file_map <- list(
  Lsurv_dist_t1 = "lew_surv_envrdist_t1.pdf",
  Lsurv_dist_t2 = "lew_surv_envrdist_t2.pdf",
  Lsurv_dist_t3 = "lew_surv_envrdist_t3.pdf",
  Ysurv_dist_t1 = "york_surv_envrdist_t1.pdf",
  Ysurv_dist_t2 = "york_surv_envrdist_t2.pdf",
  Ysurv_dist_t3 = "york_survl_envrdist_t3.pdf"
)

# We won't save these plots because we have updated plots for Figure S9 (below)

# for (name in names(file_map)) {
#   ggsave(file_map[[name]],
#          plot = plots[[name]],
#          device = "pdf",
#          path = "figures/parent_effects_H2F/",
#          height = 3, width = 5)
# }
```

## Residuals vs Survival

CR wrote the plotting code below to create Fig S9.

```{r}
# lewisetta
lew_surv1 <- resid_surv %>% 
  filter(bag_site == "Lewisetta", t == 1) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) November 2023", x = "Environmental distance to Lewisetta", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()
  
lew_surv2 <- resid_surv %>% 
  filter(bag_site == "Lewisetta", t == 2) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) May 2024", x = "Environmental distance to Lewisetta", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()

lew_surv3 <- resid_surv %>% 
  filter(bag_site == "Lewisetta", t == 3) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) November 2024", x = "Environmental distance to Lewisetta", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()

# york river
yrk_surv1 <- resid_surv %>% 
  filter(bag_site == "YorkRiver", t == 1) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) November 2023", x = "Environmental distance to York River", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()

yrk_surv2 <- resid_surv %>% 
  filter(bag_site == "YorkRiver", t == 2) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) May 2024", x = "Environmental distance to York River", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()

yrk_surv3 <- resid_surv %>% 
  filter(bag_site == "YorkRiver", t == 3) %>%
  ggplot(aes(x = dist, y = resid_surv)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-0.3,0.4)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) November 2024", x = "Environmental distance to York River", y = "Residuals of survival ~ H0 + Ar") +
  theme_classic()

plots <- list(
  "lew_surv_envrdist_residuals_t1" = lew_surv1,
  "lew_surv_envrdist_residuals_t2" = lew_surv2,
  "FigS9A_lew_surv_envrdist_residuals_t3" = lew_surv3,
  "york_surv_envrdist_residuals_t1" = yrk_surv1,
  "york_surv_envrdist_residuals_t2" = yrk_surv2,
  "FigS9C_york_surv_envrdist_residuals_t3" = yrk_surv3
)

# We will only save plots we are using in the supplement
for (name in grep("S9", names(plots), value = TRUE)) {
  ggsave(paste0(name, ".pdf"),
         plot = plots[[name]],
         device = "pdf",
         path = "figures/parent_effects_H2F",
         height = 3, width = 5)
}
```

## Residuals vs Length

```{r}
# lewisetta
lew_length1 <- resid_len %>% 
  filter(bag_site == "Lewisetta", t == 1) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-26, 25)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) November 2023", x = "Environmental distance to Lewisetta", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()
  
lew_length2 <- resid_len %>% 
  filter(bag_site == "Lewisetta", t == 2) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-26, 25)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) May 2024", x = "Environmental distance to Lewisetta", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()

lew_length3 <- resid_len %>% 
  filter(bag_site == "Lewisetta", t == 3) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-45,45)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to Lewisetta) November 2024", x = "Environmental distance to Lewisetta", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()

# york river
yrk_length1 <- resid_len %>% 
  filter(bag_site == "YorkRiver", t == 1) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-26,25)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) November 2023", x = "Environmental distance to York River", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()

yrk_length2 <- resid_len %>% 
  filter(bag_site == "YorkRiver", t == 2) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-26,25)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) May 2024", x = "Environmental distance to York River", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()

yrk_length3 <- resid_len %>% 
  filter(bag_site == "YorkRiver", t == 3) %>%
  ggplot(aes(x = dist, y = resid_len)) +
  geom_point(aes(col = pop, shape = pop), size = 4) + 
  scale_colour_manual(
    values = c("W1-TX" = "#3e4989", "W2-LA" = "#31688e", "W3-FL" = "#26828e", "S1-LOLA" = "#440154", "S2-DEBY" = "#482878", "W4-VA" = "#1f9e89", "W5-NH" = "#35b779", "W6-ME" = "#6ece58"),
    name = "Source population") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19, 20, 21, 22), name = "Source population") +
  ylim(c(-60,45)) +
  geom_smooth(method = "lm", col = "black") +
  labs(title = "Residuals vs. environmental distance (EoO to York River) November 2024", x = "Environmental distance to York River", y = "Residuals of length ~ H0 + Ar") +
  theme_classic()

plots <- list(
  "lew_length_envrdist_residuals_t1" = lew_length1,
  "lew_length_envrdist_residuals_t2" = lew_length2,
  "FigS9B_lew_length_envrdist_residuals_t3" = lew_length3,
  "york_length_envrdist_residuals_t1" = yrk_length1,
  "york_length_envrdist_residuals_t2" = yrk_length2,
  "FigS9D_york_length_envrdist_residuals_t3" = yrk_length3
)

# We will only save plots we are using in the supplement
for (name in grep("S9", names(plots), value = TRUE)) {
  ggsave(paste0(name, ".pdf"),
         plot = plots[[name]],
         device = "pdf",
         path = "figures/parent_effects_H2F",
         height = 3, width = 5)
}
```

