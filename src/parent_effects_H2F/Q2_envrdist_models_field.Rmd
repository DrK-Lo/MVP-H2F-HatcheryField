---
title: "Q2_envrdist_models_field"
author: "Nicole Mongillo"
date: "2025-07-29"
output: pdf_document
---

This file is for modeling the effects of heterozygosity, allelic richness, and environmental distance between field sites and environments-of-origin on oyster survival and length during the MVP field experiment. 

Modeling is based on code from CR. Environmental distance was calculated by KEB in envr_dist_quantiles.Rmd.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory relative to project root
knitr::opts_knit$set(root.dir = here::here())

if (!require("pacman")) install.packages("pacman")

packages <- c("tidyverse", "here", "ggplot2", "lme4", "lmerTest", "car", "broom", "broom.mixed", "corrplot", "ggstance", "stringr")
pacman::p_load(char = packages)

# log versions for reproducibility
r_version <- paste(R.version$major, R.version$minor, sep = ".")
lib_ver <- packages %>%
  map_chr(~ paste0(.x, " (v", packageVersion(.x), ")")) %>%
  paste(collapse = ", ")
```

```{r}
getwd()
```

## Read in data

Environmental distance calculations done by KEB.

```{r}
#survival data
surv_mod_ord_rename <- read.csv("data/performance_H2F/field_surv_all_times.csv")[, -1]

#length data
lengths_mod_narm_nodead <- read.csv("data/performance_H2F/field_length_all_times.csv")[ ,-1]

#parent genetics
gen_parents <- read.csv("results/parent_effects_H2F/parent_genetic_effects.csv")

#environmental distance based on scaled envr quantiles
env_dist <- read.csv("results/environment/envr_quantiles_dist_all.csv")
```

## Data preparation
```{r}
# start by putting together a complete dataframe
# genetic data
colnames(gen_parents) <- c("pop","ho","exp_hs","ar")
surv_mod_gen <- merge(surv_mod_ord_rename, gen_parents, by = "pop")

#clean env_dist. Remove all columns except distance to Lewisetta and distance to York and remove rows for LEW and YRK.
env_dist_filter <- env_dist[c(1:8), c("X", "LEW", "YRK")]
colnames(env_dist_filter) <- c("pop", "dist_LEW", "dist_YRK")

#add environmental data to df
surv_mod_gen_dist <- merge(surv_mod_gen, env_dist_filter, by = c("pop"))
```

## Assess multicollinearity
```{r}
cor_matrix_lew <- cor(surv_mod_gen_dist[,c("dist_LEW", "ho", "ar")])

#rename rows and columns
colnames(cor_matrix_lew) <- c("Distance to Lewisetta","Heterozygosity","Allelic Richness")

rownames(cor_matrix_lew) <- c("Distance to Lewisetta","Heterozygosity","Allelic Richness")

pdf(file = "figures/parent_effects_H2F/FigS8A_corrplot_lew_envrdist_H0_Ar.pdf")

corrplot_lew <- corrplot(cor_matrix_lew,
         method = "color",
         type = "upper",
         tl.col = "black",
         tl.srt = 45,
         title = "Multicollinearity of environmental distance, heterozygosity, and allelic richness (Lewisetta)",
         addCoef.col = 'black',
         mar=c(0,0,2,0))
dev.off()
#borderline collinearity with distance to Lew and ar (r = -0.69). 

cor_matrix_yrk <- cor(surv_mod_gen_dist[,c("dist_YRK", "ho", "ar")])

colnames(cor_matrix_yrk) <- c("Distance to York River","Heterozygosity","Allelic richness")

rownames(cor_matrix_yrk) <- c("Distance to York","Heterozygosity","Allelic richness")

pdf(file = "figures/parent_effects_H2F/FigS8B_corrplot_york_envrdist_H0_Ar.pdf")
corrplot_yrk <- corrplot(cor_matrix_yrk,
         method = "color",
         type = "upper",
         tl.col = "black",
         tl.srt = 45,
         title = "Multicollinearity of environmental distance, heterozygosity, and allelic richness (York River)",
         addCoef.col = 'black',
         mar=c(0,0,2,0))
dev.off()
#nothing collinear
```

### Assess VIF - Lewisetta
```{r}
VIF <- function(a, b, c){
  1/(1-summary(lm(a ~ b + c))$r.squared)
}

VIF(surv_mod_gen_dist$ho, surv_mod_gen_dist$ar, surv_mod_gen_dist$dist_LEW)
#VIF ho = 1.43

VIF(surv_mod_gen_dist$ar, surv_mod_gen_dist$dist_LEW, surv_mod_gen_dist$ho)
#VIF ar = 2.57

VIF(surv_mod_gen_dist$dist_LEW, surv_mod_gen_dist$ho, surv_mod_gen_dist$ar)
#VIF dist_LEW = 1.98
```
VIF is low enough for all remaining variables that I'm not super worried about the borderline collinearity between distance to LEW and AR.

### Assess VIF - York
```{r}
VIF(surv_mod_gen_dist$ho, surv_mod_gen_dist$ar, surv_mod_gen_dist$dist_YRK)
#VIF ho = 1.80

VIF(surv_mod_gen_dist$ar, surv_mod_gen_dist$dist_YRK, surv_mod_gen_dist$ho)
#VIF ar = 2.41

VIF(surv_mod_gen_dist$dist_YRK, surv_mod_gen_dist$ho, surv_mod_gen_dist$ar)
#VIF dist_LEW = 1.78
```
VIF is low for all.

## Modeling drivers of differences in survival

Now look at how survival changes with genetics/environment at each time point. Modeling is based on  CR's code in Q1_field_performance_models.Rmd.

### t1 survival, Lewisetta
```{r t1_surv_lew}
# RUN ON SITES SEPARATELY

# full model time point 1
# start with lew
surv_lew_t1.0 <- lm(surv ~ ho + ar + dist_LEW, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 
vif(surv_lew_t1.0) # double check vif, vif looks good

#plot(surv_lew_t1.0)
summary(surv_lew_t1.0) # ar, ho significant
drop1(surv_lew_t1.0) # final model

#make scaled version of final model for plotting
surv_t1_lew_s <- lm(scale(surv) ~ scale(ho) + scale(ar) + scale(dist_LEW), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "Lewisetta",])
```

### t2 survival, Lewisetta
```{r t1_surv_lew}
surv_lew_t2.0 <- lm(surv ~ ho + ar + dist_LEW, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 

#plot(surv_lew_t2.0)
summary(surv_lew_t2.0) # all significant
drop1(surv_lew_t2.0) # final model

#make scaled version of final model for plotting
surv_t2_lew_s <- lm(scale(surv) ~ scale(ho) + scale(ar) + scale(dist_LEW), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "Lewisetta",])
```

### t3 survival, Lewisetta
```{r t1_surv_lew}
surv_lew_t3.0 <- lm(surv ~ ho + ar + dist_LEW, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 

#plot(surv_lew_t3.0)
summary(surv_lew_t3.0) # all significant
drop1(surv_lew_t3.0) # final model

#make scaled version of final model for plotting
surv_t3_lew_s <- lm(scale(surv) ~ scale(ho) + scale(ar) + scale(dist_LEW), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "Lewisetta",])
```

### Residuals survival, Lewisetta
```{r}
# models with gen only
surv_lew_t1_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 
surv_lew_t2_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 
surv_lew_t3_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "Lewisetta",]) 

# residuals + environmental distance
# long data format
t1_lew <- surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "Lewisetta",]
t2_lew <- surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "Lewisetta",]
t3_lew <- surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "Lewisetta",]

surv_lew_resid_dist_df <- data.frame(resid_surv = surv_lew_t1_gen$residuals, 
                                    dist = t1_lew$dist_LEW, 
                                    surv = t1_lew$surv, 
                                    t = 1,
                                    pop = t1_lew$pop)

# bind rest of the data
surv_lew_dist <- rbind(surv_lew_resid_dist_df, data.frame(resid_surv = surv_lew_t2_gen$residuals,
                                        dist = t2_lew$dist_LEW, 
                                        surv = t2_lew$surv,
                                        t = 2,
                                        pop = t2_lew$pop),
      data.frame(resid_surv = surv_lew_t3_gen$residuals,
                 dist = t2_lew$dist_LEW, 
                 surv = t2_lew$surv,
                 t = 3,
                 pop = t2_lew$pop))
surv_lew_dist$bag_site <- "Lewisetta"
```

### t1 survival, York River
```{r t1_surv_lew}
surv_yrk_t1.0 <- lm(surv ~ ho + ar + dist_YRK, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(surv_yrk_t1.0)
summary(surv_yrk_t1.0) # ar, dist_YRK significant
drop1(surv_yrk_t1.0) # drop ho

surv_yrk_t1.1 <- lm(surv ~ ar + dist_YRK, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(surv_yrk_t1.1)
summary(surv_yrk_t1.1) # ar, dist_YRK significant
drop1(surv_yrk_t1.1) #final model

#make scaled version of final model for plotting
surv_t1_yrk_s <- lm(scale(surv) ~ scale(ar) + scale(dist_YRK), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "YorkRiver",])
```

### t2 survival, York River
```{r t1_surv_lew}
surv_yrk_t2.0 <- lm(surv ~ ho + ar + dist_YRK, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(surv_yrk_t2.0)
summary(surv_yrk_t2.0) # ar, dist_YRK significant
drop1(surv_yrk_t2.0) # drop ho

surv_yrk_t2.1 <- lm(surv ~ ar + dist_YRK, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(surv_yrk_t2.1)
summary(surv_yrk_t2.1) # ar, dist_YRK significant
drop1(surv_yrk_t2.1) #final model

#make scaled version of final model for plotting
surv_t2_yrk_s <- lm(scale(surv) ~ scale(ar) + scale(dist_YRK), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "YorkRiver",])
```

### t3 survival, York River
```{r t1_surv_lew}
surv_yrk_t3.0 <- lm(surv ~ ho + ar + dist_YRK, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(surv_yrk_t3.0)
summary(surv_yrk_t3.0) # ar, dist to YRK significant
drop1(surv_yrk_t3.0) # final model

#make scaled version of final model for plotting
surv_t3_yrk_s <- lm(scale(surv) ~ scale(ho) + scale(ar) + scale(dist_YRK), data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "YorkRiver",])
```

### Residuals survival, York River
```{r}
# models with gen only
surv_yrk_t1_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
surv_yrk_t2_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 
surv_yrk_t3_gen <- lm(surv ~ ho + ar, data = surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "YorkRiver",]) 

# residuals + environmental distance
# long data format
t1_yrk <- surv_mod_gen_dist[surv_mod_gen_dist$t == 1 & surv_mod_gen_dist$bag_site == "YorkRiver",]
t2_yrk <- surv_mod_gen_dist[surv_mod_gen_dist$t == 2 & surv_mod_gen_dist$bag_site == "YorkRiver",]
t3_yrk <- surv_mod_gen_dist[surv_mod_gen_dist$t == 3 & surv_mod_gen_dist$bag_site == "YorkRiver",]

surv_yrk_resid_dist_df <- data.frame(resid_surv = surv_yrk_t1_gen$residuals, 
                                    dist = t1_yrk$dist_YRK, 
                                    surv = t1_yrk$surv, 
                                    t = 1,
                                    pop = t1_yrk$pop)

# bind rest of the data
surv_yrk_dist <- rbind(surv_yrk_resid_dist_df, data.frame(resid_surv = surv_yrk_t2_gen$residuals,
                                        dist = t2_yrk$dist_YRK, 
                                        surv = t2_yrk$surv,
                                        t = 2,
                                        pop = t2_yrk$pop),
      data.frame(resid_surv = surv_yrk_t3_gen$residuals,
                 dist = t3_yrk$dist_YRK, 
                 surv = t3_yrk$surv,
                 t = 3,
                 pop = t3_yrk$pop))
surv_yrk_dist$bag_site <- "YorkRiver"
```

```{r}
# save everything
sink(paste0("results/parent_effects_H2F/models/survival_model2_envrdist_results_",Sys.Date(),".txt"))
cat("\nLewisetta t1 (November 2023) modeling approach 2\n")
summary(surv_lew_t1.0)
cat("\nLewisetta t1 (November 2023) scaled modeling approach 2\n")
summary(surv_t1_lew_s)
cat("\nLewisetta t2 (May 2024) modeling approach 2\n")
summary(surv_lew_t2.0)
cat("\nLewisetta t2 (May 2024) scaled modeling approach 2\n")
summary(surv_t2_lew_s)
cat("\nLewisetta t3 (November 2024) modeling approach 2\n")
summary(surv_lew_t3.0)
cat("\nLewisetta t3 (November 2024) scaled modeling approach 2\n")
summary(surv_t3_lew_s)
cat("\nYork River t1 (November 2023) modeling approach 2\n")
summary(surv_yrk_t1.1)
cat("\nYork River t1 (November 2023) scaled modeling approach 2\n")
summary(surv_t1_yrk_s)
cat("\nYork River t2 (May 2024) modeling approach 2\n")
summary(surv_yrk_t2.1)
cat("\nYork River t2 (May 2024) scaled modeling approach 2\n")
summary(surv_t2_yrk_s)
cat("\nYork River t3 (November 2024) modeling approach 2\n")
summary(surv_yrk_t3.0)
cat("\nYork River t3 (November 2024) scaled modeling approach 2\n")
summary(surv_t3_yrk_s)
sink()

# put together lew and york
surv_resid_dist <- rbind(surv_lew_dist, surv_yrk_dist)

# save residuals as well for supp fig
write.csv(surv_resid_dist, "results/parent_effects_H2F/residuals_distance_vs_surv.csv", row.names = F)
```

## Modeling drivers of differences in length

```{r}
# start by putting together a complete data frame
# genetic data
len_mod_gen <- merge(lengths_mod_narm_nodead, gen_parents, by = "pop")
len_mod_gen_dist <- merge(len_mod_gen, env_dist_filter, by = c("pop"))
```

### t1 length, Lewisetta
```{r t1_len_lew}
len_lew_t1.0 <- lmerTest::lmer(length ~ ho + ar + dist_LEW + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
#plot(len_lew_t1.0) 
Anova(len_lew_t1.0, type = "III") # all signif
summary(len_lew_t1.0)
step(len_lew_t1.0) # final model

len_t1_lew_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar) + scale(dist_LEW) + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
```

### t2 length, Lewisetta
```{r t1_len_lew}
len_lew_t2.0 <- lmerTest::lmer(length ~ ho + ar + dist_LEW + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
#plot(len_lew_t2.0) #one weird outlier here
Anova(len_lew_t2.0, type = "III") # ho, ar signif
summary(len_lew_t2.0)
step(len_lew_t2.0) # drop dist_LEW

len_lew_t2.1 <- lmerTest::lmer(length ~ ho + ar + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
#plot(len_lew_t2.1) #still one weird outlier
Anova(len_lew_t2.1, type = "III") # ho and ar signif
summary(len_lew_t2.1)
step(len_lew_t2.1) # final model

len_t2_lew_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar) + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
```

### t3 length, Lewisetta
```{r t1_len_lew}
len_lew_t3.0 <- lmerTest::lmer(length ~ ho + ar + dist_LEW + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
#plot(len_lew_t3.0) 
Anova(len_lew_t3.0, type = "III") # ho, ar signif
summary(len_lew_t3.0)
step(len_lew_t3.0) # drop dist_LEW

len_lew_t3.1 <- lmerTest::lmer(length ~ ho + ar + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
#plot(len_lew_t3.1) 
Anova(len_lew_t3.1, type = "III") # ho, ar signif
summary(len_lew_t3.1)
step(len_lew_t3.1) # final model

len_t3_lew_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar) + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
```

### Residuals length, Lewisetta
```{r}
# models with gen only
len_lew_t1_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
len_lew_t2_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]) 
len_lew_t3_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]) 

# long data format
len_lew_resid_dist_df <- data.frame(resid_len = len_lew_t1_gen$residuals, 
                                    dist = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]$dist_LEW, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]$length, 
                                  t = 1,
                                  pop = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "Lewisetta",]$pop)

# bind rest of the data
len_lew_dist <- rbind(len_lew_resid_dist_df, data.frame(resid_len = len_lew_t2_gen$residuals,
                                        dist = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]$dist_LEW, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]$length,
                                  t = 2,
                                  pop = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "Lewisetta",]$pop),
      data.frame(resid_len = len_lew_t3_gen$residuals,
                                        dist = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]$dist_LEW, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]$length,
                 t = 3,
                 pop = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "Lewisetta",]$pop))
len_lew_dist$bag_site <- "Lewisetta"
```

### t1 length, York River
```{r t1_len_lew}
len_yrk_t1.0 <- lmerTest::lmer(length ~ ho + ar + dist_YRK + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(len_yrk_t1.0) 
Anova(len_yrk_t1.0, type = "III") # all signif
summary(len_yrk_t1.0) #but only ar signif here
step(len_yrk_t1.0) # drop everything except bags label? I'm ignoring this due to ANOVA results, but will check with collaborators.

len_t1_yrk_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar)  + scale(dist_YRK) + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]) 

#bags have a significant effect on length
#len_yrk_t1.1<- lm(length ~ bags_label, data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
#Anova(len_yrk_t1.1, type = "III")
#plot(len_lew_t1.1) 

```

### t2 length, York River
```{r t2_len_yrk}
len_yrk_t2.0 <- lmerTest::lmer(length ~ ho + ar + dist_YRK + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(len_yrk_t2.0) 
Anova(len_yrk_t2.0, type = "III") # all signif
summary(len_yrk_t2.0)
step(len_yrk_t2.0) #final model

len_t2_yrk_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar)  + scale(dist_YRK) + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
```

### t3 length, York River
```{r t3_len_yrk}
len_yrk_t3.0 <- lmerTest::lmer(length ~ ho + ar + dist_YRK + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(len_yrk_t3.0) 
Anova(len_yrk_t3.0, type = "III") # ar signif
summary(len_yrk_t3.0)
step(len_yrk_t3.0) # drop dist_YRK

len_yrk_t3.1 <- lmerTest::lmer(length ~ ho + ar + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
#plot(len_yrk_t3.1) 
Anova(len_yrk_t3.1, type = "III") # ar, ho signif
summary(len_yrk_t3.1)
step(len_yrk_t3.1) # final model

len_t3_yrk_s <- lmerTest::lmer(scale(length) ~ scale(ho) + scale(ar)  + (1|bags_label), data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
```

### Residuals length, York River
```{r}
# models with gen only
len_yrk_t1_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
len_yrk_t2_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]) 
len_yrk_t3_gen <- lm(length ~ ho + ar, data = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]) 

# long data format
len_yrk_resid_dist_df <- data.frame(resid_len = len_yrk_t1_gen$residuals, 
                                    dist = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]$dist_YRK, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]$length, 
                                  t = 1,
                                  pop = len_mod_gen_dist[len_mod_gen_dist$t == 1 & len_mod_gen_dist$bag_site == "YorkRiver",]$pop)

# bind rest of the data
len_yrk_dist <- rbind(len_yrk_resid_dist_df, data.frame(resid_len = len_yrk_t2_gen$residuals,
                                        dist = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]$dist_YRK, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]$length,
                                  t = 2,
                                  pop = len_mod_gen_dist[len_mod_gen_dist$t == 2 & len_mod_gen_dist$bag_site == "YorkRiver",]$pop),
      data.frame(resid_len = len_yrk_t3_gen$residuals,
                                        dist = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]$dist_YRK, 
                                  length = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]$length,
                 t = 3,
                 pop = len_mod_gen_dist[len_mod_gen_dist$t == 3 & len_mod_gen_dist$bag_site == "YorkRiver",]$pop))
len_yrk_dist$bag_site <- "YorkRiver"

len_dist_resid <- rbind(len_lew_dist, len_yrk_dist)
```

```{r}
#save results
sink(paste0("results/parent_effects_H2F/models/length_model2_envrdist_results_",Sys.Date(),".txt"))
cat("\nLewisetta t1 (November 2023) modeling approach 2\n")
summary(len_lew_t1.0)
Anova(len_lew_t1.0)
cat("\nLewisetta t1 (November 2023) scaled modeling approach 2\n")
summary(len_t1_lew_s)
Anova(len_t1_lew_s)
cat("\nLewisetta t2 (May 2024) modeling approach 2\n")
summary(len_lew_t2.1)
Anova(len_lew_t2.1)
cat("\nLewisetta t2 (May 2024) scaled modeling approach 2\n")
summary(len_t2_lew_s)
Anova(len_t2_lew_s)
cat("\nLewisetta t3 (November 2024) modeling approach 2\n")
summary(len_lew_t3.1)
Anova(len_lew_t3.1)
cat("\nLewisetta t3 (November 2024) scaled modeling approach 2\n")
summary(len_t3_lew_s)
Anova(len_t3_lew_s)
cat("\nYork River t1 (November 2023) modeling approach 2\n")
summary(len_yrk_t1.0)
Anova(len_yrk_t1.0)
cat("\nYork River t1 (November 2023) scaled modeling approach 2\n")
summary(len_t1_yrk_s)
Anova(len_t1_yrk_s)
cat("\nYork River t2 (May 2024) modeling approach 2\n")
summary(len_yrk_t2.0)
Anova(len_yrk_t2.0)
cat("\nYork River t2 (May 2024) scaled modeling approach 2\n")
summary(len_t2_yrk_s)
Anova(len_t2_yrk_s)
cat("\nYork River t3 (November 2024) modeling approach 2\n")
summary(len_yrk_t3.1)
Anova(len_yrk_t3.1)
cat("\nYork River t3 (November 2024) scaled modeling approach 2\n")
summary(len_t3_yrk_s)
Anova(len_t3_yrk_s)
sink()

# save residuals as well for supp fig
write.csv(len_dist_resid, "results/performance_H2F/residuals_distance_vs_length.csv", row.names = F)
```

##Figure product - Lewisetta survival
```{r}
#save Lewisetta survival lm results as one data frame
lew_surv_dist_df <- rbind(tidy(surv_t1_lew_s), tidy(surv_t2_lew_s), tidy(surv_t3_lew_s))

#add column for sampling time
lew_surv_dist_df$t <- c(rep(c("t1"), 4), rep(c("t2"), 4), rep(c("t3"), 4))

#rename columns
colnames(lew_surv_dist_df) <- c("explanatory", "slope", "se", "tval", "pval", "t")

#remove rows with Intercept slopes
lew_surv_dist_df <- lew_surv_dist_df %>% 
  filter(explanatory != "(Intercept)")

#plot
lew_surv_dist_plot <- lew_surv_dist_df %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#F06292", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#F06292", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_LEW)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EoO to Lewisetta)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

lew_surv_dist_plot

#save plot as pdf
ggsave("Fig3B_lew_surv_envrdist.pdf",
       plot = lew_surv_dist_plot,
       device = "pdf",
       path = "figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

##Figure product - York survival
```{r}
#save York survival lm results as one dataframe
yrk_surv_dist_df <- rbind(tidy(surv_t1_yrk_s), tidy(surv_t2_yrk_s), tidy(surv_t3_yrk_s))

#add column for sampling time
yrk_surv_dist_df$t <- c(rep(c("t1"), 3), rep(c("t2"), 3), rep(c("t3"), 4))

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
yrk_surv_dist_df[nrow(yrk_surv_dist_df) + 1,] = list("scale(ho)", -.4, 0, NA, NA, "t1")
yrk_surv_dist_df[nrow(yrk_surv_dist_df) + 1,] = list("scale(ho)", -.4, 0, NA, NA, "t2")


colnames(yrk_surv_dist_df) <- c("explanatory", "slope", "se", "tval", "pval", "t")
#remove rows with Intercept slopes
yrk_surv_dist_df <- yrk_surv_dist_df %>% 
  filter(explanatory != "(Intercept)")

#plot
yrk_surv_dist_plot <- yrk_surv_dist_df %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#880E4F", size = 3.5, position = position_dodgev(height = -.85, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#880E4F", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1, 2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_YRK)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EoO to York River)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+ 
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

yrk_surv_dist_plot

#save plot as pdf
ggsave("Fig3D_york_surv_envrdist.pdf",
       plot = yrk_surv_dist_plot,
       device = "pdf",
       path = "figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

##Figure product - Lewisetta length
```{r}
#save Lewisetta survival lm results as one data frame
lew_len_dist_df <- rbind(broom.mixed::tidy(len_t1_lew_s), broom.mixed::tidy(len_t2_lew_s), broom.mixed::tidy(len_t3_lew_s))

#add column for sampling time
lew_len_dist_df$t <- c(rep(c("t1"), 6), rep(c("t2"), 5), rep(c("t3"), 5))

#rename columns
colnames(lew_len_dist_df) <- c("effect", "group", "explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#remove rows with Intercept slopes
lew_len_dist_df <- lew_len_dist_df %>% 
  filter(explanatory != "(Intercept)") %>% 
  filter(effect != "ran_pars")

lew_len_dist_df2 <- subset(lew_len_dist_df, select = -c(effect, group, df))

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
lew_len_dist_df2[nrow(lew_len_dist_df2) +1, ] = list("scale(dist_LEW)", -.5, .01, NA, NA, "t2")
lew_len_dist_df2[nrow(lew_len_dist_df2) +1, ] = list("scale(dist_LEW)", -.5, .01, NA, NA, "t3")

#plot
lew_len_dist_plot <- lew_len_dist_df2 %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#F06292", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#F06292", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_LEW)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EoO to Lewisetta)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

lew_len_dist_plot

#save plot as pdf
ggsave("FigS5B_lew_len_envrdist.pdf",
       plot = lew_len_dist_plot,
       device = "pdf",
       path = "figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

##Figure product - York length
```{r}
#save Lewisetta survival lm results as one data frame. T1 and t2 excluded everything except bag effect, so just make t3 here
yrk_len_dist_df <- rbind(broom.mixed::tidy(len_t1_yrk_s), broom.mixed::tidy(len_t2_yrk_s), broom.mixed::tidy(len_t3_yrk_s))

#add column for sampling time
yrk_len_dist_df$t <- c(rep(c("t1"), 6), rep(c("t2"), 6), rep(c("t3"), 5))
#rename columns
colnames(yrk_len_dist_df) <- c("effect", "group", "explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#remove rows with Intercept slopes
yrk_len_dist_df <- yrk_len_dist_df %>% 
  filter(explanatory != "(Intercept)") %>% 
  filter(effect != "ran_pars")

yrk_len_dist_df2 <- subset(yrk_len_dist_df, select = -c(effect, group, df))

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
yrk_len_dist_df2[nrow(yrk_len_dist_df2) +1, ] = list("scale(dist_YRK)", -.5, .01, NA, NA, "t3")


#plot
yrk_len_dist_plot <- yrk_len_dist_df2 %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#880E4F", size = 3.5, position = position_dodgev(height = -.85, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#880E4F", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1, 2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_YRK)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EoO to York River)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+ 
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

yrk_len_dist_plot

#save plot as pdf
ggsave("FigS5D_york_len_envrdist.pdf",
       plot = yrk_len_dist_plot,
       device = "pdf",
       path = "figures/parent_effects_H2F",
       height = 4,
       width = 7)
```
