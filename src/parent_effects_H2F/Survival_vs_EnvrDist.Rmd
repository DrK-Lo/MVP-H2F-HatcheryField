---
title: "survival_vs_envrdist"
author: "Nicole Mongillo"
date: "2025-08-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file compares survival for each treatment group at each common garden site to environmental distance from their EOO to the common garden environment. We found that groups from EOOs with less extreme cold temperatures have higher survival in the field experiment. Therefore, we are testing the hypothesis that the southern sites (W1-TX, W2-LA, W3-FL) are driving the positive relationship between environmental distance and survival. 

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/MVP-H2F-HatcheryField")

# load libraries
library(tidyverse) # for data wrangling
library(stringr) # for splitting strings
library(lubridate) # for dates
library(ggplot2) # for plotting
library(car) # for avPlots(), Anova()
library(emmeans) # for signif testing
library(car)
library(multcompView)
```

## Read in data
```{r}
#setwd("~/Desktop/GitHub/MVP-H2F-HatcheryField/src/parent_effects_H2F")

# read in data
surv_mod_ord_rename <- read.csv("../../data/performance_H2F/field_surv_all_times2025-07-24.csv")[, -1]

#environmental distance based on scaled envr quantiles
env_dist <- read.csv("../../data/envr_of_origin/envr_quantiles_dist_all.csv")
```

## Data preparation
### Clean data and create merged data frame
```{r}
#remove H1-HYBRIDMIX and H2-SEEDMIX from survival
surv_sub <- surv_mod_ord_rename %>% 
  filter(pop != "H1-HYBRIDMIX" & pop!= "H2-SEEDMIX")

#keep only columns for environmental distance to LEW and YRK, exclude rows where common garden sites are compared to themselves
env_dist_cg <- env_dist[1:8, c(1, 10:11)]
colnames(env_dist_cg) <- c("pop", "dist_LEW", "dist_YRK")

#find mean survival for each pop at each monitoring event at each cg site
surv_means <- aggregate(surv_mod_ord_rename$surv, by = list(surv_mod_ord_rename$pop, surv_mod_ord_rename$bag_site, surv_mod_ord_rename$t), FUN = mean)

colnames(surv_means) <- c("pop", "bag_site", "t", "mean_surv")

#merge surv and environmental distance data
surv_dist_means <- merge(surv_means, env_dist_cg, by = "pop")

surv_dist_means$t <- as.character(surv_dist_means$t)

surv_dist_means$pop <- factor(surv_dist_means$pop, levels = c("W1-TX", "W2-LA", "W3-FL", "W4-VA", "S1-LOLA", "S2-DEBY",  "W5-NH", "W6-ME"))
```

## Plot 

KEB edited to just define plotting settings once and change as needed. 

```{r}

# shared plot settings
site_config <- list(
  Lewisetta = list(dist_col = "dist_LEW", label = "Lewisetta"),
  YorkRiver = list(dist_col = "dist_YRK", label = "York River")
)

time_labels <- c("1" = "November 2023", "2" = "May 2024", "3" = "November 2024")

# function to create a single plot
make_surv_plot <- function(data, site, t_val) {
  cfg <- site_config[[site]]
  
  data %>%
    filter(bag_site == site, t == t_val) %>%
    ggplot(aes(x = .data[[cfg$dist_col]], y = mean_surv)) +
    geom_point(aes(shape = pop), size = 2.5) +
    scale_shape_manual(name = "EOO", values = c(15, 16, 17, 18, 4, 3, 7, 10)) +
    ylim(c(0, 1)) +
    ggtitle(str_wrap(paste0("Survival vs. environmental distance (EOO to ", cfg$label, ")"), width = 35)) +
    labs(subtitle = time_labels[t_val]) +
    xlab(paste0("Environmental distance (EOO to ", cfg$label, ")")) +
    ylab("% Survival") +
    theme_classic() +
    theme(
      panel.grid.major = element_line(color = "grey90"),
      axis.text = element_text(color = "black"),
      plot.subtitle = element_text(color = "black")
    )
}

# generate all plots
plots <- list()
for (site in names(site_config)) {
  prefix <- ifelse(site == "Lewisetta", "L", "Y")
  for (t_val in c("1", "2", "3")) {
    name <- paste0(prefix, "surv_dist_t", t_val)
    plots[[name]] <- make_surv_plot(surv_dist_means, site, t_val)
    print(plots[[name]])
  }
}

# Save all plots
file_map <- list(
  Lsurv_dist_t1 = "lew_survival_envrdist_t1.pdf",
  Lsurv_dist_t2 = "lew_survival_envrdist_t2.pdf",
  Lsurv_dist_t3 = "lew_survival_envrdist_t3.pdf",
  Ysurv_dist_t1 = "york_survival_envrdist_t1.pdf",
  Ysurv_dist_t2 = "york_survival_envrdist_t2.pdf",
  Ysurv_dist_t3 = "york_survival_envrdist_t3.pdf"
)

for (name in names(file_map)) {
  ggsave(file_map[[name]],
         plot = plots[[name]],
         device = "pdf",
         path = "../../figures/parent_effects_H2F/survival_envrdist",
         height = 3, width = 5)
}
```

