---
title: "Q2_condition_index_models_field"
author: "Nicole Mongillo"
date: "2025-07-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script is for modeling the effects of genetics and environment-of-origin environmental conditions on oyster condition index during the MVP field experiment. Multicollinearity and VIF assessments for these explanatory variables are conducted in the F_Surv_Length_Gen_Env.Rmd file.

CI data/calculations come from ZS. Modeling chunks are based on code from CR with variables switched out as needed.

## Load packages
```{r}
library(tidyverse) # for data wrangling
library(stringr) # for splitting strings
library(lubridate) # for dates
library(ggplot2) # for plotting
library(plotrix) # for std error
library(lme4) # for lmm
library(performance) # for lmm
library(lmerTest) # for lmm
library(car) # for avPlots(), Anova()
library(emmeans) # for signif testing
library(car)
library(multcompView)
library(corrplot)
library(broom) #save lm results as tables
library(ggstance) #vertical position.dodge function
library(broom.mixed) #save lmer results as tables
```

## Read in data
```{r}
#setwd("~/Desktop/GitHub/MVP-H2F-HatcheryField/src/parent_effects_H2F")

#Condition index data
ci_df <- read_csv("../../data/condition_index_H2F/MVP_phenotyping_final.csv", show_col_types = FALSE)

#parent genetics
gen_parents <- read.csv("../../data/parent_effects_H2F/parent_genetic_effects.csv")

#environment of origin quantiles
env_parents <- read.csv("../../data/environment/quantiles_11092025.csv")[,-c(1, 9)]

#environmental distance based on scaled envr quantiles
env_dist <- read.csv("../../data/envr_of_origin/envr_quantiles_dist_all.csv")
```

## Data preparation

### Clean CI data
```{r}
#make population a character column
ci_df$population <- as.character(ci_df$population)

#remove LARMIX (aka HYBRIDMIX) and SEEDMIX
ci_filter <- ci_df %>% 
  filter(population != "H1-LARMIX" & population != "H2-SEEDMIX" & population != "NA")

# put the populations in correct factor order
ci_df$population <- factor(ci_df$population, levels = c("W1-TX", "W2-LA", "W3-FL", "S1-LOLA", "S2-DEBY", "W4-VA", "W5-NH", "W6-ME"))

#select only relevant columns
ci_sub <- subset(ci_filter, select = c("CI", "samplingTimePoint", "site", "population", "bagID"))

#recode sampling time points as t1, t2, t3
ci_sub$samplingTimePoint <- as.factor(ci_sub$samplingTimePoint)
ci_sub$samplingTimePoint <- fct_recode(ci_sub$samplingTimePoint, t1 = "2023-11", t2 = "2024-05", t3 = "2024-11")

#recode field sites as Lewisetta and York
ci_sub$site <- as.factor(ci_sub$site)
ci_sub$site <- fct_recode(ci_sub$site, Lewisetta = "LEW", YorkRiver = "YR")

#rename columns
colnames(ci_sub) <- c("ci", "t", "bag_site", "pop", "bags_label")
```

### Combine CI, envr quantile, and genetic data
```{r}
colnames(gen_parents) <- c("pop","ho","exp_hs","ar")
ci_gen <- merge(ci_sub, gen_parents, by = "pop")

#clean env_parents
colnames(env_parents) <- c("pop","salinity_quantile_10","salinity_quantile_90","Salinity_st_dev","temp_quantile_10","temp_quantile_90","Temperature_st_dev")

#add environmental data to df
ci_gen_env <- merge(ci_gen, env_parents, by = c("pop"))
```

### Combine CI, envr distance, and genetic data
```{r}
#clean env_dist. Remove all columns except distance to Lewisetta and distance to York and remove rows for LEW and YRK.
env_dist_filter <- env_dist[c(1:8), c("X", "LEW", "YRK")]
colnames(env_dist_filter) <- c("pop", "dist_LEW", "dist_YRK")

#add environmental data to df
ci_gen_dist <- merge(ci_gen, env_dist_filter, by = c("pop"))
```


## Run analyses - Model 1 (Genetics and envr quantiles)
### T1 CI, Lewisetta
```{r t1_ci_lew}
ci_t1_lew <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "Lewisetta",])

#plot(ci_t1_lew) 
Anova(ci_t1_lew, type = "III") # nothing signif
summary(ci_t1_lew)
step(ci_t1_lew) # Function says to drop everything, including random effect, except ho. We will keep the random effect for consistency among all tests, but note this in the results.

ci_t1_lew2 <-lmerTest::lmer(ci ~ ho + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "Lewisetta",]) 
#plot(ci_t1_lew2) 
Anova(ci_t1_lew2, type = 3)
summary(ci_t1_lew2) # final model

ci_t1_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "Lewisetta",])
summary(ci_t1_lew_scaled)
```

### T2 CI, Lewisetta
```{r t2_ci_lew}
ci_t2_lew <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "Lewisetta",]) 
#plot(ci_t2_lew) 
Anova(ci_t2_lew, type = "III") # nothing signif, but temp10 is borderline significant based on p-val (p = 0.06)
summary(ci_t2_lew)
step(ci_t2_lew) # says drop everything but ho, but will keep temp10 and check again

ci_t2_lew2 <- lmerTest::lmer(ci ~ temp_quantile_10 + ho + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "Lewisetta",]) 
#plot(ci_t2_lew2) 
Anova(ci_t2_lew2, type = "III") # both temp10 and ho significant
summary(ci_t2_lew2)
step(ci_t2_lew2) #says to drop random effect, we will keep it for consistency among all models. Also drop temp10

ci_t2_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "Lewisetta",])
```

### T3 CI, Lewisetta
```{r t3_ci_lew}
ci_t3_lew <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "Lewisetta",]) 
#plot(ci_t3_lew) 
Anova(ci_t3_lew, type = "III") # sal10 signif
summary(ci_t3_lew)
step(ci_t3_lew) # drop everything but sal10 and ar, we will keep the random effect for consistency among all models

ci_t3_lew2 <- lmerTest::lmer(ci ~ ar + salinity_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "Lewisetta",])

#plot(ci_t3_lew) 
Anova(ci_t3_lew2) #sal10 signif
summary(ci_t3_lew2)
step(ci_t3_lew2) #final model

ci_t3_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ar) +  scale(salinity_quantile_10) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "Lewisetta",])
```

### T1 CI, York
```{r t1_ci_yrk}
ci_t1_yrk <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "YorkRiver",]) 
#plot(ci_t1_yrk) 
Anova(ci_t1_yrk, type = "III") # ho and sal10 signif
summary(ci_t1_yrk)
step(ci_t1_yrk) # drop everything but ho and sal10, function says to drop random effect but we will keep it for consistency between models

ci_t1_yrk2 <-lmerTest::lmer(ci ~ ho + salinity_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "YorkRiver",])
#plot(ci_t1_yrk2) 
Anova(ci_t1_yrk2) #both signif
summary(ci_t1_yrk2)

ci_t1_yrk_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + scale(salinity_quantile_10) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t1" & ci_gen_env$bag_site == "YorkRiver",])
```

### T2 CI, York
```{r t2_ci_yrk}
ci_t2_yrk <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "YorkRiver",]) 
#plot(ci_t2_yrk) 
Anova(ci_t2_yrk, type = "III") # ar signif
summary(ci_t2_yrk)
step(ci_t2_yrk) # drop everything but ar keep random effect

ci_t2_yrk2 <-lmerTest::lmer(ci ~ ar + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "YorkRiver",]) 
#plot(ci_t2_yrk2) 
Anova(ci_t2_yrk2, type = "III") #both signif
summary(ci_t2_yrk2)


ci_t2_yrk_scaled <- lmerTest::lmer(scale(ci) ~ scale(ar) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t2" & ci_gen_env$bag_site == "YorkRiver",])
```

### T3 CI, York
```{r t3_ci_yrk}
ci_t3_yrk <- lmerTest::lmer(ci ~ ho + ar + salinity_quantile_10 + salinity_quantile_90 + temp_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "YorkRiver",]) 
#plot(ci_t3_yrk) 
Anova(ci_t3_yrk, type = "III") # sal10, ar signif
summary(ci_t3_yrk)
step(ci_t3_yrk) # drop everything but ar and sal10, keep random effect

ci_t3_yrk2 <-lmerTest::lmer(ci ~ ar + salinity_quantile_10 + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "YorkRiver",]) 
#plot(ci_t3_yrk2) 
Anova(ci_t3_yrk2, type = "III") #both signif
summary(ci_t3_yrk2)
step(ci_t3_yrk2) # final model

ci_t3_yrk_scaled <- lmerTest::lmer(scale(ci) ~ scale(ar) + scale(salinity_quantile_10) + (1|bags_label), data = ci_gen_env[ci_gen_env$t == "t3" & ci_gen_env$bag_site == "YorkRiver",]) 
# save everything
sink(paste0("../../results_field/condition_GE_model1_results_",Sys.Date(),".txt"))
cat("\nLEW t1 (May 2023) modeling approach 1\n")
summary(ci_t1_lew2)
Anova(ci_t1_lew2)
cat("\nLEW t1 (May 2023) scaled modeling approach 1\n")
summary(ci_t1_lew_scaled)
Anova(ci_t1_lew_scaled)
cat("\nLEW t2 (Nov. 2023) modeling approach 1\n")
summary(ci_t2_lew2)
Anova(ci_t2_lew2)
cat("\nLEW t2 (Nov. 2023) scaled modeling approach 1\n")
summary(ci_t2_lew_scaled)
Anova(ci_t2_lew_scaled)
cat("\nLEW t3 (May 2024) modeling approach 1\n")
summary(ci_t3_lew2)
Anova(ci_t3_lew2)
cat("\nLEW t3 (May 2024) scaled modeling approach 1\n")
summary(ci_t3_lew_scaled)
Anova(ci_t3_lew_scaled)
cat("\nYRK t1 (May 2023) modeling approach 1\n")
summary(ci_t1_yrk2)
Anova(ci_t1_yrk2)
cat("\nYRK t1 (May 2023) scaled modeling approach 1\n")
summary(ci_t1_yrk_scaled)
Anova(ci_t1_yrk_scaled)
cat("\nYRK t2 (Nov. 2023) modeling approach 1\n")
summary(ci_t2_yrk2)
Anova(ci_t2_yrk2)
cat("\nYRK t2 (Nov. 2023) scaled modeling approach 1\n")
summary(ci_t2_yrk_scaled)
Anova(ci_t2_yrk_scaled)
cat("\nYRK t3 (May 2024) modeling approach 1\n")
summary(ci_t3_yrk2)
Anova(ci_t3_yrk2)
cat("\nYRK t3 (May 2024) scaled modeling approach 1\n")
summary(ci_t3_yrk_scaled)
Anova(ci_t3_yrk_scaled)
sink()
```

## Run Analyses- Model 2 (genetic variables and environmental distance)
### T1 CI Dist, Lewisetta
```{r}
dist_t1_lew <- lmerTest::lmer(ci ~ ho + ar + dist_LEW + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t1" & ci_gen_dist$bag_site == "Lewisetta",]) 
#plot(dist_t1_lew) 
Anova(dist_t1_lew, type = "III") # nothing signif
summary(dist_t1_lew)
step(dist_t1_lew) # drop everything except ho, says to drop random effect, but will keep for consistency between models

dist_t1_lew2 <- lmerTest::lmer(ci ~ ho + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t1" & ci_gen_dist$bag_site == "Lewisetta",]) 
summary(dist_t1_lew2) #final model

dist_t1_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t1" & ci_gen_dist$bag_site == "Lewisetta",])
```

### T2 CI Dist, Lewisetta
```{r}
dist_t2_lew <- lmerTest::lmer(ci ~ ho + ar + dist_LEW + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "Lewisetta",]) 
#plot(dist_t2_lew) 
Anova(dist_t2_lew, type = "III") # ho signif
summary(dist_t2_lew)
step(dist_t2_lew) # drop everything except ho, keep random effect

dist_t2_lew2 <-lmerTest::lmer(ci ~ ho + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "Lewisetta",]) 
#plot(dist_t2_lew2) 
summary(dist_t2_lew2)
step(dist_t2_lew2) #final model

dist_t2_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "Lewisetta",]) 
```

### T3 CI Dist, Lewisetta
```{r}
dist_t3_lew <- lmerTest::lmer(ci ~ ho + ar + dist_LEW + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t3" & ci_gen_dist$bag_site == "Lewisetta",]) 
#plot(dist_t3_lew) 
Anova(dist_t3_lew, type = "III") # ho, ar, dist_LEW signif
summary(dist_t3_lew)
step(dist_t3_lew) # says to drop random effect, but ignoring for consistency

dist_t3_lew_scaled <- lmerTest::lmer(scale(ci) ~ scale(ho) + scale(ar) + scale(dist_LEW) + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t3" & ci_gen_dist$bag_site == "Lewisetta",]) 
```

### T1 CI Dist, York
```{r}
dist_t1_yrk <- lmerTest::lmer(ci ~ ho + ar + dist_YRK + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t1" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t1_yrk) 
Anova(dist_t1_yrk, type = "III") # nothing signif
summary(dist_t1_yrk)
step(dist_t1_yrk) # drop everything, except random effect

dist_t1_yrk2 <-lm(ci ~ bags_label, data = ci_gen_dist[ci_gen_dist$t == "t1" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t1_yrk2) 
Anova(dist_t1_yrk2) #signif effect of bag label

#plot this as nothing significant, note the significant effect of bag label in figure caption
```

### T2 CI Dist, York
```{r}
dist_t2_yrk <- lmerTest::lmer(ci ~ ho + ar + dist_YRK + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t2_yrk) 
Anova(dist_t2_yrk, type = "III") # ar, dist_YRK signif
summary(dist_t2_yrk)
step(dist_t2_yrk) # drop ho

dist_t2_yrk2 <-lmerTest::lmer(ci ~ ar + dist_YRK + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t2_yrk2) 
Anova(dist_t2_yrk2) #both signif
summary(dist_t2_yrk2)
step(dist_t2_yrk2) #final model

dist_t2_yrk_scaled <- lmerTest::lmer(scale(ci) ~ scale(ar) + scale(dist_YRK) + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t2" & ci_gen_dist$bag_site == "YorkRiver",]) 
```

### T3 CI Dist, York
```{r}
dist_t3_yrk <- lmerTest::lmer(ci ~ ho + ar + dist_YRK + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t3" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t3_yrk) 
Anova(dist_t3_yrk, type = "III") # ho signif
summary(dist_t3_yrk)
step(dist_t3_yrk) # drop dist_YRK

dist_t3_yrk2 <-lmerTest::lmer(ci ~ ar + ho + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t3" & ci_gen_dist$bag_site == "YorkRiver",]) 
#plot(dist_t3_yrk2) 
Anova(dist_t3_yrk2) #both signif
summary(dist_t3_yrk2)
step(dist_t3_yrk2) #final model

dist_t3_yrk_scaled <- lmerTest::lmer(scale(ci) ~ scale(ar) + scale(ho) + (1|bags_label), data = ci_gen_dist[ci_gen_dist$t == "t3" & ci_gen_dist$bag_site == "YorkRiver",]) 

#save results
sink(paste0("../../results_field/condition_GEdist_model2_results_",Sys.Date(),".txt"))
cat("\nLEW t1 (May 2023) modeling approach 2\n")
summary(dist_t1_lew2)
Anova(dist_t1_lew2)
cat("\nLEW t1 (May 2023) scaled modeling approach 2\n")
summary(dist_t1_lew_scaled)
Anova(dist_t1_lew_scaled)
cat("\nLEW t2 (Nov. 2023) modeling approach 2\n")
summary(dist_t2_lew2)
Anova(dist_t2_lew2)
cat("\nLEW t2 (Nov. 2023) scaled modeling approach 2\n")
summary(dist_t2_lew_scaled)
Anova(dist_t2_lew_scaled)
cat("\nLEW t3 (May 2024) modeling approach 2\n")
summary(dist_t3_lew)
Anova(dist_t3_lew)
cat("\nLEW t3 (May 2024) scaled modeling approach 2\n")
summary(dist_t3_lew_scaled)
Anova(dist_t3_lew_scaled)
cat("\nYRK t1 (May 2023) modeling approach 2\n")
summary(dist_t1_yrk2)
Anova(dist_t1_yrk2)
cat("\nYRK t2 (Nov. 2023) modeling approach 2\n")
summary(dist_t2_yrk2)
Anova(dist_t2_yrk2)
cat("\nYRK t2 (Nov. 2023) scaled modeling approach 2\n")
summary(dist_t2_yrk_scaled)
Anova(dist_t2_yrk_scaled)
cat("\nYRK t3 (May 2024) modeling approach 2\n")
summary(dist_t3_yrk2)
Anova(dist_t3_yrk2)
cat("\nYRK t3 (May 2024) scaled modeling approach 2\n")
summary(dist_t3_yrk_scaled)
Anova(dist_t3_yrk_scaled)
sink()
```

## Plotting - NM
##Figure product - Lewisetta CI model 1 (environmental quantiles)
```{r}
lew_ci1_df <- rbind(broom.mixed::tidy(ci_t1_lew_scaled), tidy(ci_t2_lew_scaled), tidy(ci_t3_lew_scaled))
lew_ci1_df$t <- c(rep(c("t1"), 4), rep(c("t2"), 4), rep(c("t3"), 5))

#remove rows with Intercept slopes and ran_par
lew_ci1_df <- lew_ci1_df %>% 
  filter(term != "(Intercept)") %>% 
  filter(effect != "ran_pars")

#remove cols for effect and group
lew_ci1_df_sub <- subset(lew_ci1_df, select = -c(effect, group)) 

colnames(lew_ci1_df_sub) <- c("explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
#t1
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t1")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t1")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(salinity_quantile_10)",-.4,.01,NA,NA, NA,"t1")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t1")
#t2
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t2")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(salinity_quantile_10)",-.4,.01,NA,NA,NA,"t2")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t2")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t2")
#t3
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(ho)",-.4,.01,NA,NA,NA,"t3")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t3")
lew_ci1_df_sub[nrow(lew_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t3")

#plot
lew_ci1_plot <- lew_ci1_df_sub %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#F06292", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#F06292", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(salinity_quantile_10)", "scale(salinity_quantile_90)", "scale(temp_quantile_10)", "scale(ho)", "scale(ar)"), 
                   labels = c("Salinity Q10", "Salinity Q90", "Temperature Q10",  str_wrap(c("Heterozygosity/ Temperature Q90"), width = 17), str_wrap(c("Allelic richness/ Temperature Q90"), width = 20)))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

lew_ci1_plot

ggsave("FigS7A_lew_ci_quantiles.pdf",
       plot = lew_ci1_plot,
       device = "pdf",
       path = "../../figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

#Plotting slopes - York CI model 1 (environmental quantiles)
```{r}
yrk_ci1_df <- rbind(broom.mixed::tidy(ci_t1_yrk_scaled), tidy(ci_t2_yrk_scaled), tidy(ci_t3_yrk_scaled))
yrk_ci1_df$t <- c(rep(c("t1"), 5), rep(c("t2"), 4), rep(c("t3"), 5))

#remove rows with Intercept slopes and ran_par
yrk_ci1_df <- yrk_ci1_df %>% 
  filter(term != "(Intercept)") %>% 
  filter(effect != "ran_pars")

#remove cols for effect and group
yrk_ci1_df_sub <- subset(yrk_ci1_df, select = -c(effect, group)) 

colnames(yrk_ci1_df_sub) <- c("explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
#t1
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t1")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t1")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t1")
#t2
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(ho)",-.4,.01,NA,NA,NA,"t2")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(salinity_quantile_10)",-.4,.01,NA,NA,NA,"t2")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t2")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t2")
#t3
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(ho)",-.4,.01,NA,NA,NA,"t3")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(temp_quantile_10)",-.4,.01,NA,NA,NA,"t3")
yrk_ci1_df_sub[nrow(yrk_ci1_df_sub)+1,]=list("scale(salinity_quantile_90)",-.4,.01,NA,NA,NA,"t3")

#plot
yrk_ci1_plot <- yrk_ci1_df_sub %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#880E4F", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#880E4F", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "Nov. 2023", "t2" = "May 2024", "t3" = "Nov. 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(salinity_quantile_10)", "scale(salinity_quantile_90)", "scale(temp_quantile_10)", "scale(ho)", "scale(ar)"), 
                   labels = c("Salinity Q10", "Salinity Q90", "Temperature Q10",  str_wrap(c("Heterozygosity/ Temperature Q90"), width = 17), str_wrap(c("Allelic richness/ Temperature Q90"), width = 20)))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

yrk_ci1_plot

ggsave("FigS7C_york_ci_quantiles.pdf",
       plot = yrk_ci1_plot,
       device = "pdf",
       path = "../../figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

#Plotting slopes - Lewisetta CI model 2
```{r}
#save scaled functions
lew_ci2_df <- rbind(broom.mixed::tidy(dist_t1_lew_scaled),broom.mixed::tidy(dist_t2_lew_scaled),broom.mixed::tidy(dist_t3_lew_scaled))
lew_ci2_df$t <- c(rep(c("t1"), 4), rep(c("t2"), 4), rep(c("t3"), 6))

#remove rows with Intercept slopes and ran_par
lew_ci2_df <- lew_ci2_df %>% 
  filter(term != "(Intercept)") %>% 
  filter(effect != "ran_pars")

#remove cols for effect and group
lew_ci2_df_sub <- subset(lew_ci2_df, select = -c(effect, group)) 

colnames(lew_ci2_df_sub) <- c("explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
#t1
lew_ci2_df_sub[nrow(lew_ci2_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t1")
lew_ci2_df_sub[nrow(lew_ci2_df_sub)+1,]=list("scale(dist_LEW)",-.4,.01,NA,NA,NA,"t1")
#t2
lew_ci2_df_sub[nrow(lew_ci2_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t2")
lew_ci2_df_sub[nrow(lew_ci2_df_sub)+1,]=list("scale(dist_LEW)",-.4,.01,NA,NA,NA,"t2")

lew_ci2_plot <- lew_ci2_df_sub %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#F06292", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#F06292", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, values = c("t1" = .45, "t2" = .7, "t3" = 1), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, values = c("t1" = 15, "t2" = 16, "t3" = 17), labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_LEW)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EOO to Lewisetta)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

lew_ci2_plot

ggsave("FigS7B_lew_ci_dist.pdf",
       plot = lew_ci2_plot,
       device = "pdf",
       path = "../../figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

#Plotting slopes - York length
```{r}
#save scaled functions, all t1 rows will have to be added manually, as nothing was significant from that model, except bag label
yrk_ci2_df <- rbind(broom.mixed::tidy(dist_t2_yrk_scaled),broom.mixed::tidy(dist_t3_yrk_scaled))
yrk_ci2_df$t <- c(rep(c("t2"), 5), rep(c("t3"), 5))

#remove rows with Intercept slopes and ran_par
yrk_ci2_df <- yrk_ci2_df %>% 
  filter(term != "(Intercept)") %>% 
  filter(effect != "ran_pars")

#remove cols for effect and group
yrk_ci2_df_sub <- subset(yrk_ci2_df, select = -c(effect, group)) 

colnames(yrk_ci2_df_sub) <- c("explanatory", "slope", "se", "Fstat", "df", "pval", "t")

#add dummy rows for time points lacking variables so that position_dodge v plots each data point in the same time point at consistent vertical positions for each y axis variable
#t1
yrk_ci2_df_sub[nrow(yrk_ci2_df_sub)+1,]=list("scale(ho)",-.4,.01,NA,NA,NA,"t1")
yrk_ci2_df_sub[nrow(yrk_ci2_df_sub)+1,]=list("scale(ar)",-.4,.01,NA,NA,NA,"t1")
yrk_ci2_df_sub[nrow(yrk_ci2_df_sub)+1,]=list("scale(dist_YRK)",-.4,.01,NA,NA,NA,"t1")
#t2
yrk_ci2_df_sub[nrow(yrk_ci2_df_sub)+1,]=list("scale(ho)",-.4,.01,NA,NA,NA,"t2")
#t3
yrk_ci2_df_sub[nrow(yrk_ci2_df_sub)+1,]=list("scale(dist_YRK)",-.4,.01,NA,NA,NA,"t3")

yrk_ci2_plot <- yrk_ci2_df_sub %>% 
  ggplot(aes(x = slope, y = explanatory))+
  geom_point(aes(alpha = t, shape = t), color = "#880E4F", size = 3.5, position = position_dodge2v(height = .85, reverse = T, preserve = "total"))+
  geom_errorbarh(aes(xmax = slope + 2*se, xmin = slope - 2*se, alpha= t), color = "#880E4F", height = 0, size = 1.2, position = position_dodgev(height = -.85, preserve = "total"))+
  scale_alpha_manual(name = "Time", na.translate = F, 
                     values = c("t1" = .45, "t2" = .7, "t3" = 1), 
                     labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  scale_shape_manual(name = "Time", na.translate = F, 
                     values = c("t1" = 15, "t2" = 16, "t3" = 17), 
                     labels = c("t1" = "November 2023", "t2" = "May 2024", "t3" = "November 2024"))+
  xlim(c(-1,2))+
  xlab("Slope on scaled data")+
  ylab("Variable")+
  geom_vline(xintercept = 0, linetype = "dashed")+
   scale_y_discrete(name = "Explanatory variable", 
                   limits = c("scale(dist_YRK)", "scale(ho)", "scale(ar)"),
                   labels = c(str_wrap(c("Environmental distance (EOO to York River)"), width = 20), "Heterozygosity", "Allelic richness"))+
  theme_classic()+
    theme(axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15))

yrk_ci2_plot

ggsave("FigS7D_york_ci_dist.pdf",
       plot = yrk_ci2_plot,
       device = "pdf",
       path = "../../figures/parent_effects_H2F",
       height = 4,
       width = 7)
```

