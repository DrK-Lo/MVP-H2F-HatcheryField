---
title: "Q1_field_performance_models"
author: "Camille Rumberger"
date: "`r Sys.Date()`"
output: html_document
---

This script is for modeling differences in survival and length amongst bags/populations/sites/time points in the MVP Field Experiment. I intend to use linear (mixed) models to examine how survival and length vary by group.

## Load packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory relative to project root
knitr::opts_knit$set(root.dir = here::here())

if (!require("pacman")) install.packages("pacman")

packages <- c("tidyverse", "ggplot2", "plotrix", "lme4", "lmerTest", "performance", "car", "emmeans", "multcompView", "corrplot")
pacman::p_load(char = packages)

# log versions for reproducibility
r_version <- paste(R.version$major, R.version$minor, sep = ".")
lib_ver <- packages %>%
  map_chr(~ paste0(.x, " (v", packageVersion(.x), ")")) %>%
  paste(collapse = ", ")
```

```{r}
getwd()
```

## Modeling differences in survival

First I'll read in and process survival data.

Then I can use LMMs to look at differences in survival by group.

```{r}
surv_mod_ord_rename <- read.csv("data/performance_H2F/field_surv_all_times.csv")[, -1]
surv_mod_ord_rename$t <- as.factor(surv_mod_ord_rename$t)

# analysis of fixed effects
anova(lm(surv ~ pop + bag_site + t, data = surv_mod_ord_rename)) # all significant

# start with full model, then subtract each interaction, then subtract two of the interaction
lmm1 <- lm(surv ~ bag_site * pop * t, data = surv_mod_ord_rename) # no bags label
#plot(lmm1)
Anova(lmm1, type = "III")
drop1(lmm1)
# could drop three way interaction, this is Satterwaithe's method
lmm1.1 <- lm(surv ~ bag_site * pop * t - bag_site:pop:t, data = surv_mod_ord_rename) # no bags label
Anova(lmm1.1, type = "III") # all signif except bag_site

# one more model on final time point only
lmm2 <- lm(surv ~ bag_site * pop, data = surv_mod_ord_rename[surv_mod_ord_rename$t == 3,])
#plot(lmm2)
Anova(lmm2, type = "III")
drop1(lmm2)
TukeyHSD(aov(lmm2))
# another way to do this, in em-means package can get Tukey to letters in plot

#sink(paste0("results/performance_H2F/Q1_survival_model_results_",Sys.Date(),".txt"))
Anova(lmm1.1, type = "III")
Anova(lmm2, type = "III")
sink()

# plot survival at last time point
surv_t3 <- surv_mod_ord_rename[surv_mod_ord_rename$t == 3,]

# these are very basic plots, nicer ones with significance and proper colors are below
surv_t3_plot_site <- ggplot(surv_t3, aes(x = pop, y = surv, fill = bag_site)) + 
  geom_boxplot(position=position_dodge(0.8)) +
#  geom_dotplot(binaxis='y', stackdir='center', 
#               position=position_dodge(0.8)) +
  ggtitle("Survival at Final Time Point") +
  theme_classic()
surv_t3_plot_site

surv_t3_plot_pop <- ggplot(surv_t3, aes(x = bag_site, y = surv, fill = pop)) + 
  geom_boxplot(position=position_dodge(1.0)) +
#  geom_dotplot(binaxis='y', stackdir='center', 
#               position=position_dodge(1.0)) +
  theme_classic()
surv_t3_plot_pop

# try adding a different pop column that's split
surv_t3$oldpop <- str_split_fixed(surv_t3$pop,"-",2)[,2]

# now redo model
lmm2.1 <- lm(surv ~ bag_site * oldpop, data = surv_t3)
#plot(lmm2.1)
summary(lmm2.1)
Anova(lmm2.1, type = "III") # make sure to always use this method if two categorical predictors and  interaction and unbalanced design ; type III may have to set the contrast, check biostats notes
tuk_surv_t3 <- TukeyHSD(aov(lmm2.1), conf.level = 0.95)
cld_surv_t3 <- multcompLetters4(aov(lmm2.1), tuk_surv_t3)

# can paste pops with sites to line up with letters output
surv_t3$popsite <- paste0(surv_t3$bag_site,":",str_split_fixed(surv_t3$pop,"-",2)[,2])

# multcomp letters to get letters
letters_surv_t3_df <- data.frame(letters = as.data.frame.list(cld_surv_t3$`bag_site:oldpop`), popsite = names((cld_surv_t3$`bag_site:oldpop`)$Letters))
letters_surv_t3_df_red <- letters_surv_t3_df[,c("letters.Letters","popsite")]
colnames(letters_surv_t3_df_red) <- c("letters","popsite")

# save these outputs too
sink("results/performance_H2F/Q1_survival_model_results.txt")
Anova(lmm1.1, type = "III")
Anova(lmm2, type = "III")
Anova(lmm2.1, type = "III")
letters_surv_t3_df_red
sink()

# merge
surv_final_time_rename_mg <- merge(surv_t3, letters_surv_t3_df_red, by = "popsite")

write.csv(surv_final_time_rename_mg, "data/performance_H2F/field_surv_final_time.csv")

# plot
# pop color scheme
pop_colors <- data.frame(pop = c("W1-TX","W2-LA","W3-FL","S1-LOLA","S2-DEBY","W4-VA","W5-NH","W6-ME","H1-HYBRIDMIX","H2-SEEDMIX"), hex = c("#3e4989","#31688e","#26828e","#440154","#482878","#1f9e89","#35b779","#6ece58","#fde725","#b5de2b"), order = 1:10)

surv_final_time_plotting <- merge(surv_final_time_rename_mg, pop_colors, by = "pop")

# plot by pop
surv_t3_plot_pop <- ggplot(surv_final_time_plotting, aes(x = bag_site, y = surv, fill = fct_reorder(pop, order))) + 
  geom_boxplot(position=position_dodge(1.0)) +  
  scale_fill_manual(name = "Broodstock Group", label = pop_colors$pop, values = pop_colors$hex)+
  geom_text(aes(label = letters, y = 1), vjust = -0.5, position=position_dodge(1)) +
  labs(title = "Survival at Final Time Point", x = "Experimental Site", y = "Survival") +
  theme_classic()
surv_t3_plot_pop

#ggsave(paste0("figures/performance_H2F/survival_t3_h2f_",Sys.Date(),".pdf"), plot = surv_t3_plot_pop, width = 10, height = 6, dpi = 300)
```


## Modeling differences in length

Now I'll try modeling differences in length. I'll start by reading in and processing the length data.

I will then use LMMs to look at differences in length by grouping.

```{r}
lengths_mod_narm_nodead <- read.csv("data/performance_H2F/field_length_all_times.csv")[, -1]

# analysis of fixed effects
lengths_mod_narm_nodead$t <- as.factor(lengths_mod_narm_nodead$t)
modtemp0 <- lm(length ~ pop * bag_site * t, data = lengths_mod_narm_nodead) # outlier 1174
modtemp <- Anova(lm(length ~ pop * bag_site * t, data = lengths_mod_narm_nodead)) # all significant
boxplot(residuals(modtemp0) ~ lengths_mod_narm_nodead$bags_label) # looks for random effects

# try again
modtemp0.1 <- lm(length ~ pop * bag_site * t, data = lengths_mod_narm_nodead) # outlier 1174
modtemp.1 <- Anova(lm(length ~ pop * bag_site * t, data = lengths_mod_narm_nodead), type = "III") # all significant
boxplot(residuals(modtemp0.1) ~ lengths_mod_narm_nodead$bags_label) # looks for random effects

# with interactions
# using REML
lmm3 <- lmer(length ~ bag_site * pop * t + (1|bags_label), data = lengths_mod_narm_nodead)
Anova(lmm3, type = "III") # all signif except bag_site:t

# start with full model, then subtract each interaction, then subtract two of the interaction
drop1(lmm3) # says to drop the three way interaction - this is Satterthwaite's method

# for growth, need random effect because multiple different obs per bag - start with growth data with same stuff but no random effects, box plot residuals against bag_id

# one more model on final time point only
lmm4 <- lmer(length ~ bag_site * pop + (1|bags_label), data = lengths_mod_narm_nodead[lengths_mod_narm_nodead$t == 3,])
plot(lmm4)
Anova(lmm4, type = "III") # all significant

emmeans_lmm4 <- emmeans::emmeans(lmm4, ~bag_site * pop) # get estimated marginal means
(pairwise_contrasts_lmm4 <- emmeans(lmm4, ~ bag_site * pop) )

pairs(emmeans_lmm4, simple = "bag_site")
pairs(emmeans_lmm4, simple = "pop")

test(pairs(emmeans_lmm4, by = "bag_site"), by = NULL, adjust = "mvt")
test(pairs(emmeans_lmm4, by = "pop"), by = NULL, adjust = "mvt")

# can paste pops with sites to do a traditional Tukey - this is separate from the rest of the modeling
lengths_final_time <- lengths_mod_narm_nodead[lengths_mod_narm_nodead$t == 3,]
lengths_final_time$popsite <- paste0(lengths_final_time$bag_site,":",str_split_fixed(lengths_final_time$pop,"-",2)[,2])

(aov_len_t3 <- aov(lm(length ~ popsite, data = lengths_final_time)))
#plot(aov_len_t3) # looks good!
(tukey_len_t3 <- TukeyHSD(aov_len_t3, conf.level = 0.95))

# multcomp letters to get letters
anova_len_t3 <- (Anova(lm(length ~ popsite, data = lengths_final_time)))
letters_len_t3 <- multcompLetters4(aov_len_t3, tukey_len_t3)

letters_len_t3_df <- data.frame(letters = as.data.frame.list(letters_len_t3$popsite)$Letters, popsite = rownames(as.data.frame.list(letters_len_t3$popsite)))

lengths_final_time_rename_mg <- merge(lengths_final_time, letters_len_t3_df, by = "popsite")
(lengths_final_time_rename_mg)

# need sd for letters
summary_len_t3 <- lengths_final_time_rename_mg %>%
  summarise(mean_len = mean(length), sd = sd(length)) %>%
  arrange()

# save all this 
sink("results/performance_H2F/Q1_length_model_results.txt")
Anova(lmm3, type = "III")
Anova(lmm4, type = "III")
anova_len_t3
letters_len_t3
sink()

write.csv(lengths_final_time_rename_mg, "data/performance_H2F/field_length_final_time.csv")

write.csv(letters_len_t3_df, "results/performance_H2F/Q1_field_length_letters.csv")

len_final_time_plotting <- merge(lengths_final_time_rename_mg, pop_colors, by = "pop")

# plot by pop
len_t3_plot_pop <- ggplot(len_final_time_plotting, aes(x = bag_site, y = length, fill = fct_reorder(pop, order))) + 
  geom_boxplot(position=position_dodge(1.0)) +  
  scale_fill_manual(name = "Broodstock Group", label = pop_colors$pop, values = pop_colors$hex)+
  geom_text(aes(label = letters, y = 115), vjust = -0.5, position=position_dodge(1)) +
  labs(title = "Length at Final Time Point", x = "Experimental Site", y = "Survival") +
  theme_classic()
len_t3_plot_pop

#ggsave(paste0("figures/performance_H2F/length_t3_h2f_",Sys.Date(),".pdf"), plot = len_t3_plot_pop, width = 10, height = 6, dpi = 300)
```